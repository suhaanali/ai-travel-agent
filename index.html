<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Agent - Your Smart Travel Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    


<style>
/* ======================================================
   AI Travel Agent ‚Äì Clean Compact UI (v3)
   Palette: Navy (#0B2C5E) + Gold (#B2924C) + Green (#1EAD64)
====================================================== */
#loading-indicator {
  display: none !important;
  visibility: hidden !important;
}

/* ---------- GLOBAL ---------- */
body {
  font-family: "Inter", "Poppins", sans-serif;
  font-size: 13px;
  background: #f8fafc;
  color: #333;
  line-height: 1.4;
  padding: 12px;
}

/* ---------- MAIN CONTAINER ---------- */
.compact-container {
  max-width: 420px;
  height: 640px;
  margin: 0 auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ---------- HEADER ---------- */
.compact-header {
  background: linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%);
  color: #fff;
  padding: 16px 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.compact-header h1 {
  font-size: 17px;
  font-weight: 700;
  margin: 0;
}
.compact-header p {
  font-size: 12px;
  opacity: 0.9;
}

/* ---------- CHAT SECTION ---------- */
.compact-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.compact-bubble {
  padding: 10px 14px;
  border-radius: 16px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  animation: fadeIn 0.3s ease;
}

/* ‚úÖ Final wrapping fix ‚Äî clean, reliable, mobile-safe */
/* ‚úÖ FINAL FIX: multi-line wrapping for user and agent bubbles */
.user-bubble,
.agent-bubble {
  display: block !important;           /* inline-block still gets overridden under flex */
  max-width: 80%;
  white-space: normal !important;      /* force wrapping */
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.5;
  text-align: left;
}

/* ‚úÖ fix the flex parent container */
.compact-messages > .flex {
  align-items: flex-start !important;
  flex-wrap: wrap !important;
  width: 100%;
  gap: 0.25rem;
}

/* optional: ensure internal <br> or markdown formatting render correctly */
.user-bubble br,
.agent-bubble br {
  display: block;
  margin-bottom: 0.25rem;
  content: "";
}




/* AGENT BUBBLE */
.agent-bubble {
  background: #fff;
  align-self: flex-start;
  max-width: 95%;
  border-radius: 14px;
}

/* ---------- FLIGHT HEADER BANNER ---------- */
.header-gradient {
  background: linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%);
  color: #fff;
  font-size: 12.5px;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-bottom: 8px;
}

/* ---------- TABS ---------- */
/* --- Tabs Row --- */
.tab-buttons {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 6px 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #fff;
}

/* --- Individual Tab Buttons --- */
.tab-btn {
  flex: 0 0 auto; /* prevents full stretch */
  padding: 6px 14px;
  font-size: 8px;
  font-weight: 600;
  color: #030f21;
  border-radius: 8px;
  background: #fcfcfc;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.tab-btn:hover {
  background: #f1f5f9;
  color: #0B2C5E;
  border-color: #cbd5e1;
}

/* --- Active Tab --- */
.tab-btn.active {
  background: #ffffff;
  color: ##11546d;
  border: 1px solid #8a8eab;
  font-weight: 900;
  box-shadow: 0 2px 4px rgba(11, 44, 94, 0.25);
}

/* --- Tab Content --- */
.tab-content {
  padding: 10px 12px;
}


/* ---------- FLIGHT CARD ---------- */
.flight-card {
  background: #fff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}
.flight-card:hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  transform: translateY(-1px);
}

/* Flight route section */
.flight-route {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
.flight-route .time {
  font-size: 13px;
  font-weight: 600;
  color: #0B2C5E;
}
.flight-route .duration {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
  color: #555;
}
.flight-route .plane-line {
  position: relative;
  height: 1px;
  width: 60px;
  background: #ccc;
}
.flight-route .plane-line::before {
  content: "‚úàÔ∏è";
  position: absolute;
  top: -9px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
}

/* Flight bottom section */
.flight-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
}
.flight-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11.5px;
  color: #444;
}
.flight-info img {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  object-fit: contain;
}
.flight-price {
  font-weight: 700;
  font-size: 13px;
  color: #1EAD64;
}
/* --- Flight Card Container --- */
.agent-bubble .tab-content {
  padding: 8px 6px; /* reduce side padding so cards can stretch */
}

/* --- Flight Card --- */
.compact-flight-card {
  width: 98%;              /* make it wider */
  margin: 6px auto;        /* center it */
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 10px 14px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.compact-flight-card:hover {
  border-color: #0B2C5E;
  box-shadow: 0 4px 10px rgba(11, 44, 94, 0.1);
  transform: translateY(-1px);
}


/* ---------- INPUT AREA ---------- */
/* === CHAT INPUT BAR CLEAN + ALIGNED === */
.input-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  background: #fff;
  padding: 10px 14px;
  border-top: 1px solid #e5e7eb;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
}

/* Input Field */
.compact-input {
  flex: 1;
  height: 44px;
  padding: 0 16px;
  border: 1px solid #e2e8f0;
  border-radius: 22px;
  font-size: 13px;
  color: #1e293b;
  background: #f8fafc;
  outline: none;
  transition: all 0.2s ease;
}

.compact-input:focus {
  background: #fff;
  box-shadow: 0 0 0 2px rgba(11, 44, 94, 0.15);
}

/* Send Button */
.send-button {
  flex-shrink: 0;
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 50%;
  background: linear-gradient(135deg, #0B2C5E 0%, #B2924C 100%) !important;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(11, 44, 94, 0.25);
  transition: all 0.25s ease;
}

.send-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(11, 44, 94, 0.3);
}

/* Send Button Icon */
.send-button svg {
  stroke: #ffffff !important;
  stroke-width: 2;
  width: 18px;
  height: 18px;
}
#room-detail-view.slide-in {
    transform: translateX(0);
}

#room-detail-view {
    transform: translateX(100%);
}




/* ---------- ANIMATIONS & SCROLL ---------- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}
.compact-messages::-webkit-scrollbar {
  width: 5px;
}
.compact-messages::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}
.compact-messages::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ‚úÖ Fix: Force proper wrapping for user and agent bubbles */
.user-bubble,
.agent-bubble,
.compact-bubble {
  display: inline-block !important;
  max-width: 75%;
  white-space: normal !important;     /* enable line wrapping */
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.5;
  text-align: left;
}

/* ‚úÖ Fix: Allow flex containers to wrap their children */
.compact-messages > .flex {
  align-items: flex-start !important;
  flex-wrap: wrap !important;
  width: 100%;
}

/* ‚úÖ Optional: Make long links or URLs wrap gracefully */
.compact-bubble a,
.compact-bubble span {
  white-space: normal !important;
  word-break: break-word !important;
}
/* ‚úÖ FINAL FIX ‚Äî multiline user input wrapping (confirmed working) */

/* Allow message containers to wrap properly */
.flex.justify-end, 
.flex.justify-start {
  display: flex !important;
  flex-wrap: wrap !important;
  align-items: flex-start !important;
  max-width: 100%;
}

/* Fix bubble text wrapping */
.user-bubble, 
.agent-bubble {
  display: inline-block !important;
  white-space: normal !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  max-width: 85%;
  line-height: 1.5;
  text-align: left;
}

/* Ensure input bar stays unaffected */
.input-wrapper {
  flex-wrap: nowrap !important;
}

/* ‚úÖ Multi-line Auto-Wrapping Input */
.compact-input {
  flex: 1;
  height: 44px;
  min-height: 44px;
  max-height: 120px;
  padding: 10px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 22px;
  font-size: 13px;
  color: #1e293b;
  background: #f8fafc;
  outline: none;
  resize: none;
  overflow-y: hidden;              /* ‚úÖ no scrollbar flicker */
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.5;
  transition: height 0.15s ease;
}

.input-wrapper {
  align-items: flex-end;
  padding: 10px 14px;
}

#cart-panel {
    transition: transform 0.18s ease, opacity 0.18s ease;
  }

/* Smooth modal animation */
#quote-display-modal > div {
  animation: pop 0.25s ease;
}

@keyframes pop {
  from { transform: scale(.92); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}


</style>

</head>

<body class="bg-gray-50 m-0 p-0 w-full h-screen overflow-hidden">

  <!-- ‚ú® Floating decorative elements -->
  <div class="floating-element floating-1"></div>
  <div class="floating-element floating-2"></div>

  <!-- Error Boundary -->
  <div id="error-boundary" class="hidden"></div>

  <!-- üåç Main Container -->
  <div class="fixed inset-0 flex flex-col bg-white overflow-hidden">

<!-- üîπ Header -->
<header class="bg-gradient-to-r from-[#0B2C5E] to-[#B2924C] text-white flex items-center justify-between px-4 py-3 shadow-md z-10 w-full">

  <!-- Left: Logo + Title -->
  <div class="flex items-center space-x-3">
    <div class="bg-white p-1.5 rounded-xl shadow-md flex items-center justify-center border border-yellow-500/40">
      <img src="static/Logo.jpg" alt="Logo" class="w-6 h-6 sm:w-8 sm:h-8 object-contain">
    </div>
    <div>
      <h1 class="font-semibold text-base sm:text-lg tracking-wide">AI Travel Agent</h1>
      <p class="text-[10px] sm:text-xs opacity-90">Your intelligent travel companion</p>
    </div>
  </div>

  <!-- Right: Floating Header Cart Button -->
  <div id="cart-float-btn"
       class="relative cursor-pointer select-none"
       title="Selected Flights">

      <div class="w-8 h-8 flex items-center justify-center bg-white/90 rounded-full shadow-md border border-yellow-500/40 text-black text-lg">
        ‚úàÔ∏è
      </div>

      <!-- Notification badge -->
      <span id="cart-count"
            class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] px-1.5 py-[1px] rounded-full hidden">
        0
      </span>
  </div>
</header>



<!-- üõí Floating Cart Panel -->
<div id="cart-panel"
     class="fixed top-20 right-3 w-72 bg-white rounded-xl shadow-xl border border-gray-200 p-4 z-50 hidden transition-all duration-300 translate-x-5 opacity-0">

    <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-gray-800">‚úàÔ∏è Selected Flights</h3>
        <button id="cart-close-btn" class="text-red-500 text-sm font-semibold hover:underline">
            Close
        </button>
    </div>

<!-- ‚≠ê Markup Dropdown -->
<div class="mb-3">
    <label class="text-sm font-semibold text-gray-700">Markup:</label>
    <select id="markup-select" class="border rounded px-2 py-1 text-sm ml-2">
        <option value="0">0%</option>
        <option value="1">1%</option>
        <option value="2">2%</option>
        <option value="3">3%</option>
        <option value="4">4%</option>
        <option value="5">5%</option>
        <option value="6">6%</option>
        <option value="7">7%</option>
        <option value="8">8%</option>
        <option value="9">9%</option>
        <option value="10">10%</option>
    </select>
</div>

<!-- ‚≠ê Share Buttons -->
<div class="flex gap-2 mb-3">
    <button id="copy-flights-btn"
        class="bg-blue-600 text-white px-3 py-1 rounded text-xs shadow">
        Copy All
    </button>

    <button id="share-whatsapp-btn"
        class="bg-green-600 text-white px-3 py-1 rounded text-xs shadow">
        WhatsApp
    </button>
</div>


    <!-- Cart items dynamically added here -->
    <div id="cart-items" class="space-y-3 max-h-80 overflow-y-auto">
        <p class="text-gray-500 text-sm">No flights selected yet.</p>
    </div>

<!-- üè® Selected Hotels -->
<div id="cart-hotels" class="mt-4">
    <h4 class="text-sm font-semibold text-gray-700 mb-2">üè® Selected Hotels</h4>
    <div id="cart-hotel-items" class="space-y-2"></div>
</div>


</div>





<!-- üìå Cart Toggle Script (Fixed & Smooth) -->
<script>
  const cartBtn = document.getElementById("cart-float-btn");
  const cartPanel = document.getElementById("cart-panel");
  const cartClose = document.getElementById("cart-close-btn");

  // Reset state before opening
  function openCart() {
    cartPanel.classList.remove("hidden");

    // Always reset animation start state
    cartPanel.classList.remove("translate-x-0", "opacity-100");
    cartPanel.classList.add("translate-x-5", "opacity-0");

    // Smooth animation in the next frame
    requestAnimationFrame(() => {
      cartPanel.classList.remove("translate-x-5", "opacity-0");
      cartPanel.classList.add("translate-x-0", "opacity-100");
    });
  }

  function closeCart() {
    // Start closing animation
    cartPanel.classList.remove("translate-x-0", "opacity-100");
    cartPanel.classList.add("translate-x-5", "opacity-0");

    // After animation ends, hide it
    setTimeout(() => {
      cartPanel.classList.add("hidden");
    }, 180); // must match CSS transition duration
  }

  cartBtn.addEventListener("click", openCart);
  cartClose.addEventListener("click", closeCart);


function applyMarkup(price, percent) {
    percent = Number(percent);
    if (!percent || percent === 0) return price;
    return Math.round(price * (1 + percent / 100));
}


</script>




    <!-- üí¨ Chat Area -->
    <main id="chat-history" class="flex-1 overflow-y-auto bg-gray-50 px-3 py-4">

      <!-- Welcome Message -->
      <div class="flex justify-start">
        <div class="agent-bubble">
          <div class="flex items-center space-x-3 mb-2">
            <div class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-white shadow">
              <img src="./static/person.png" alt="AI Travel Agent" class="object-contain w-7 h-7">
            </div>
            <div>
              <h3 class="font-bold text-gray-900">Welcome to AI Travel Agent!</h3>
              <p class="text-sm text-gray-600">I can help you find flights, hotels, and more.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Flight Tabs -->
      <div id="flight-tabs" class="hidden bg-white rounded-lg shadow-sm mt-4 w-full">
        <div class="flex border-b border-gray-200 text-sm font-medium w-full">
          <button class="tab-btn active flex-1 text-center py-2 border-r border-gray-200" data-tab="tab1">One-way</button>
          <button class="tab-btn flex-1 text-center py-2 border-r border-gray-200" data-tab="tab2">Round-trip</button>
          <button class="tab-btn flex-1 text-center py-2" data-tab="tab3">Multi-city</button>
        </div>
        <div id="tab1" class="tab-content block p-3 w-full"></div>
        <div id="tab2" class="tab-content hidden p-3 w-full"></div>
        <div id="tab3" class="tab-content hidden p-3 w-full"></div>
      </div>

    </main>
<!-- üè® HOTEL RESULTS WINDOW (Floating Panel) -->
<div id="hotel-results-window"
     class="fixed bottom-6 right-6 w-96 max-h-[80vh] bg-white border border-gray-300 shadow-xl rounded-lg overflow-y-auto hidden z-50">

    <div class="p-3 border-b font-semibold text-lg flex justify-between items-center bg-gray-100">
        Hotels Found
        <button onclick="closeHotelResults()" class="text-red-500 hover:text-red-700 text-sm">‚úñ</button>
    </div>

    <div id="hotel-results-content" class="p-3 space-y-4">
        <!-- Hotel cards get injected here -->
    </div>
</div>

    <!-- ‚úçÔ∏è Input Section -->
    <footer class="bg-white border-t border-gray-200 p-3 space-y-3 w-full">
      

      <!-- Input Bar -->
      <div class="flex gap-2 items-end">
        <textarea
          id="user-input"
          class="flex-grow border border-gray-300 rounded-lg p-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-400"
          placeholder="Ask about flights, hotels, weather..."
          rows="1"
        ></textarea>
        <button
          id="send-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 flex items-center justify-center transition"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>

      <!-- Inline Loader -->
      <div id="loading-indicator" class="hidden mt-2">
        <div class="flex items-center justify-center space-x-2 text-gray-600">
          <div class="loading-spinner rounded-full h-4 w-4 border-2 border-blue-200 border-t-blue-600 animate-spin"></div>
          <span class="font-medium text-sm">Processing your request...</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- üíÖ Style Fixes -->
  <style>
    /* spacing between chat bubbles */
    #chat-history > div {
      margin-bottom: 1rem;
    }

    /* user bubble */
    .user-bubble {
      background: #e9f5ff;
      color: #0b2c5e;
      padding: 10px 14px;
      border-radius: 16px 16px 4px 16px;
      max-width: 85%;
      align-self: flex-end;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      word-wrap: break-word;
    }

    /* agent bubble */
    .agent-bubble {
      background: #fff;
      border-radius: 16px 16px 16px 4px;
      max-width: 90%;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    /* breathing room */
    #chat-history {
      padding-bottom: 4.5rem !important;
    }

    /* make flight cards take full width */
    .flight-card,
    .flight-result,
    .flight-offer {
      width: 100% !important;
      max-width: none !important;
      margin: 0 auto;
    }

    /* responsive tweaks */
    @media (max-width: 640px) {
      main#chat-history {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .user-bubble,
      .agent-bubble {
        max-width: 95%;
      }
    }
  </style>
</body>

    <!-- Firebase & Application Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const CONFIG = {
            BACKEND_URL: 'https://ai-travel-agent-backend-0i7n.onrender.com/api/search',
            HISTORY_COLLECTION: 'chat_messages',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000
        };
window.__block_auto_focus = false;


        // Elements
        const elements = {
            chatHistory: document.getElementById('chat-history'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            loadingOverlay: document.getElementById('loading-overlay'),
            multiCopyContainer: document.getElementById('multi-copy-container'),
            multiCopyBtn: document.getElementById('multi-copy-btn'),
            selectedSummary: document.getElementById('selected-flight-summary'),
            selectedText: document.getElementById('selected-flight-text'),
            confirmBtn: document.getElementById('confirm-selection-btn'),
            clearBtn: document.getElementById('clear-selected-flights'),
            errorBoundary: document.getElementById('error-boundary')
        };

        // Global state
        window.appState = {
            selectedFlights: [],
            currentSessionId: 'session_' + Math.random().toString(36).substring(2, 15),
            retryCount: 0
        };

        // Firebase state
        let db = null;
        let auth = null;
        let userId = 'anon_user';

        // Utility functions
function showLoading(show = true) {
  if (show) {
    elements.loadingIndicator.style.display = 'block';
    elements.sendBtn.disabled = true;
  } else {
    elements.loadingIndicator.style.display = 'none';
    elements.sendBtn.disabled = false;
  }
}

// === Quote Modal Logic ===

// Add Passenger Button
document.getElementById("addPassengerBtn").onclick = () => {
  const list = document.getElementById("passengerList");

  const row = document.createElement("div");
  row.className = "flex items-center gap-2 mb-2 passenger-row";

  row.innerHTML = `
    <input 
      type="text" 
      class="flex-1 p-2 border rounded-lg passenger-name text-sm"
      placeholder="Passenger Name">

    <select class="w-24 p-2 border rounded-lg passenger-type text-sm">
      <option value="Adult">Adult</option>
      <option value="Child">Child</option>
      <option value="Infant">Infant</option>
    </select>
  `;

  list.appendChild(row);
};


// Cancel button
document.getElementById("cancelQuoteBtn").onclick = () => {
  document.getElementById("quote-form-modal").classList.add("hidden");
};




// üî• Function to read modal, close modal, and call generateQuote()
function handleGenerateQuote() {
  const customer = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();
  const email = document.getElementById("customerEmail").value.trim();

  const passengers = [...document.querySelectorAll(".passenger-row")]
    .map(row => ({
      name: row.querySelector(".passenger-name").value.trim(),
      type: row.querySelector(".passenger-type").value
    }))
    .filter(p => p.name.length > 0);

  // CLOSE form modal
  document.getElementById("quote-form-modal").classList.add("hidden");

  // Generate the quotation
  generateQuote(window.appState.selectedFlights, {
    customer, phone, email, passengers
  });
}

// Attach event
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("confirmQuoteBtn");
  if (btn) btn.addEventListener("click", handleGenerateQuote);
});







function generateQuote(flights, details) {
  const { customer, phone, email, passengers } = details;

  const quoteRef = "QT-" + Date.now().toString().slice(-6);
  const dateIssued = new Date().toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric"
  });

  const shortDate = d => new Date(d).toLocaleDateString("en-US", {
    day: "numeric",
    month: "short",
    year: "numeric"
  });

  const formatDuration = dur => {
    const h = dur.match(/(\d+)H/)?.[1] || "0";
    const m = dur.match(/(\d+)M/)?.[1] || "0";
    return `${h}h ${m}m`;
  };

  /* ------------------------------------------
      GROUP PASSENGERS BY TYPE
  -------------------------------------------*/
  const grouped = passengers.reduce((acc, p) => {
    acc[p.type] = (acc[p.type] || 0) + 1;
    return acc;
  }, {});

  const passengerSummary = Object.entries(grouped)
    .map(([type, count]) => `${count}√ó ${type}${count > 1 ? "s" : ""}`)
    .join(" ‚Ä¢ ");

  /* ------------------------------------------
      FLIGHT CARDS
  -------------------------------------------*/
  const flightCards = flights.map((f, i) => `
    <div class="border border-gray-300 rounded-xl p-4 shadow-sm bg-white">

      <div class="flex justify-between items-start mb-3">

        <div class="flex items-center gap-3">
          <img src="https://content.airhex.com/content/logos/airlines_${f.carrierCode}_100_100_s.png"
               class="w-10 h-10 rounded-full object-contain bg-white"
               onerror="this.style.display='none'">

          <div>
            <div class="text-[13px] font-semibold text-gray-800 uppercase">
              ${f.carrierName}
            </div>
            <div class="text-[12px] text-gray-500">${f.flightNumber}</div>
          </div>
        </div>

        <div class="text-green-600 font-bold text-lg">
          ${f.price.total} ${f.price.currency}
        </div>
      </div>

      <div class="grid grid-cols-3 text-[12px]">

        <div>
          <div class="font-semibold">${f.departureTime} Depart</div>
          <div class="text-gray-500">${shortDate(f.departureDate)}</div>
          <div class="font-semibold mt-1">${f.origin}</div>
        </div>

        <div class="flex flex-col items-center text-center">
          <div class="text-indigo-600 font-medium flex items-center gap-1">
            ‚úà ${formatDuration(f.flightDuration)}
          </div>
          <div class="text-orange-600 font-semibold">
            ${f.stops === 0 ? "Non-stop" : `1 stop via ${f.via}`}
          </div>
        </div>

        <div class="text-right">
          <div class="font-semibold">${f.arrivalTime} Arrive</div>
          <div class="text-gray-500">${shortDate(f.arrivalDate)}</div>
          <div class="font-semibold mt-1">${f.destination}</div>
        </div>

      </div>

      <hr class="border-gray-300 my-3">

      <div class="text-[12px] space-y-1">
        <div class="text-gray-700">üß≥ ${f.baggage || "25 KG"} ‚Ä¢ ${f.cabin || "Economy"}</div>
        <div class="text-gray-800 font-semibold">
          üë§ 1√óAdult = ${f.price.total} ${f.price.currency}
        </div>
      </div>

    </div>
  `).join("");

  /* ------------------------------------------
      FINAL HTML
  -------------------------------------------*/
  const html = `
    <div>
      <h3 class="font-semibold text-indigo-700 mb-1">üë§ Client</h3>
      <div><strong>Name:</strong> ${customer}</div>
      <div><strong>Phone:</strong> ${phone}</div>
      <div><strong>Email:</strong> ${email}</div>

      <h3 class="font-semibold text-indigo-700 mt-4 mb-1">üßç Travelers (${passengers.length})</h3>

      <!-- Grouped summary -->
      <div class="text-[13px] font-medium text-gray-800 mb-1">
        ${passengerSummary}
      </div>

      <!-- Individual names -->
      <div class="text-[12px] text-gray-600">
        ${passengers.map(p => `<div>${p.name} ‚Äî ${p.type}</div>`).join("")}
      </div>

      <h3 class="font-semibold text-indigo-700 mt-4 mb-1">üõ´ Flight Options</h3>
      <div class="space-y-4">${flightCards}</div>

      <p class="text-[11px] text-gray-500 text-center mt-4">
        Prices subject to change until confirmed.
      </p>
    </div>
  `;

  document.getElementById("quote-content").innerHTML = html;
  document.getElementById("quote-ref").innerText = `Ref: ${quoteRef} ‚Ä¢ ${dateIssued}`;
  document.getElementById("quote-display-modal").classList.remove("hidden");
}


function openQuoteModal() {
  document.getElementById("quote-display-modal").classList.remove("hidden");
}


function copyQuote() {
  const text = document.getElementById("quote-content").innerText;
  navigator.clipboard.writeText(text);
  alert("Quotation copied!");
}







function buildShareMessage() {
    const flights = window.appState.selectedFlights;
    if (!flights.length) return "No flights selected.";

    const markup = Number(document.getElementById("markup-select")?.value || 0);
    let msg = "üåü *Premium Flight Quote*\n\n";

    flights.forEach((f, index) => {
        const fb = f.fare_breakdown || {};
        const currency = f.price.currency || "AED";

        const adultTotal  = fb.adults?.total   ? applyMarkup(fb.adults.total, markup)   : 0;
        const childTotal  = fb.children?.total ? applyMarkup(fb.children.total, markup) : 0;
        const infantTotal = fb.infants?.total  ? applyMarkup(fb.infants.total, markup)  : 0;
        const totalPrice  = applyMarkup(f.price.total, markup);

        msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

        msg += `üõ´ *${index === 0 ? "Outbound" : "Inbound"}*\n`;
        msg += `‚úàÔ∏è Airline: ${f.carrierName || ""} (${f.flightNumber || ""})\n`;
        msg += `üåç ${f.origin} ‚ûù ${f.destination}\n`;
        msg += `üìÖ ${f.departureDate}\n`;

        msg += `‚è± ${f.departureTime} ‚Üí ${f.arrivalTime}`;
        if (f.arrivalDate && f.arrivalDate !== f.departureDate) {
            msg += ` (${f.arrivalDate})`;
        }

        msg += `\n\nüíº Baggage: ${f.baggage || "‚Äî"}\n`;
        msg += `üí∫ Cabin: ${f.cabin || "ECONOMY"}\n\n`;

        msg += `üë• *Fare Details*\n`;
        if (fb.adults?.count)
            msg += `‚Ä¢ Adult √ó${fb.adults.count} ‚Äî ${adultTotal} ${currency}\n`;
        if (fb.children?.count)
            msg += `‚Ä¢ Child √ó${fb.children.count} ‚Äî ${childTotal} ${currency}\n`;
        if (fb.infants?.count)
            msg += `‚Ä¢ Infant √ó${fb.infants.count} ‚Äî ${infantTotal} ${currency}\n`;

        msg += `\nüí∞ *Total Fare:* ${totalPrice} ${currency}\n\n`;
    });

    msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê";

    return msg.trim();
}

// üìã COPY TO CLIPBOARD
document.addEventListener("click", e => {
    if (e.target.id === "copy-flights-btn") {
        const msg = buildShareMessage();
        navigator.clipboard.writeText(msg);
    }
});


// üí¨ SHARE TO WHATSAPP
document.addEventListener("click", e => {
    if (e.target.id === "share-whatsapp-btn") {
        const msg = encodeURIComponent(buildShareMessage());
        const url = `https://wa.me/?text=${msg}`;
        window.open(url, "_blank");
    }
});


function addSelectAllToggle(container) {
  if (!container) return;

  // Avoid duplicate buttons
  if (container.querySelector(".select-all-toggle")) return;

  const selectAllBtn = document.createElement("button");
  selectAllBtn.className =
    "select-all-toggle bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";
  selectAllBtn.textContent = "Select All Flights";

  selectAllBtn.addEventListener("click", () => {
    const cards = container.querySelectorAll(".flight-card");

    if (cards.length === 0) return;

    const allSelected = [...cards].every(card =>
      card.classList.contains("selected")
    );

    if (allSelected) {
      // üëâ DESELECT ALL
      window.appState.selectedFlights = [];

      cards.forEach(card => {
        card.classList.remove("selected", "ring-2", "ring-blue-500", "bg-blue-50");
      });

      selectAllBtn.textContent = "Select All Flights";
      updateSelectionSummary();
      return;
    }

    // üëâ SELECT ALL
    window.appState.selectedFlights = [];

    cards.forEach(card => {
      const flight = JSON.parse(card.dataset.flight);
      window.appState.selectedFlights.push(flight);
      card.classList.add("selected", "ring-2", "ring-blue-500", "bg-blue-50");
    });

    selectAllBtn.textContent = "Deselect All Flights";
    updateSelectionSummary();
  });

  container.appendChild(selectAllBtn);
}










        function showError(message) {
            const errorHtml = `
                <div class="error-banner fade-in">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-red-500">‚ö†Ô∏è</span>
                            <div>
                                <p class="font-semibold">Something went wrong</p>
                                <p class="text-sm">${message}</p>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">
                            ‚úñ
                        </button>
                    </div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = errorHtml;
            elements.chatHistory.appendChild(tempDiv.firstElementChild);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        function showSuccess(message) {
            const successHtml = `
                <div class="success-banner fade-in">
                    <div class="flex items-center space-x-3">
                        <span class="text-green-500">‚úÖ</span>
                        <p class="font-semibold">${message}</p>
                    </div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = successHtml;
            elements.chatHistory.appendChild(tempDiv.firstElementChild);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        // Initialize Firebase
        async function initFirebaseAndAuth() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                
                if (!firebaseConfig) {
                    console.warn("Firebase configuration missing - chat history disabled");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                if (window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`User authenticated: ${userId}`);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                showError("Chat history is temporarily unavailable");
            }
        }

        // Message handling
        async function saveMessage(text, role, type = 'text', data = null) {
            displayMessage(text, role, type, data);

            if (!db || !auth.currentUser) {
                console.warn("Firestore not available - message not saved");
                return;
            }

            try {
                const messageData = {
                    text: text,
                    role: role,
                    type: type,
                    data: data,
                    timestamp: new Date(),
                    userId: userId,
                    appId: window.__app_id || 'travel-agent',
                    sessionId: window.appState.currentSessionId
                };

                const collectionPath = `artifacts/${window.__app_id}/users/${userId}/${CONFIG.HISTORY_COLLECTION}`;
                await addDoc(collection(db, collectionPath), messageData);
                
            } catch (error) {
                console.error("Error saving message:", error);
            }
        }

function displayMessage(text, role, type = "text", data = null) {
            const isUser = role === "user";
            const alignment = isUser ? "justify-end" : "justify-start";
            const bubbleClass =
  role === "agent-quote"
    ? "agent-bubble agent-quote compact-bubble"
    : isUser
    ? "user-bubble compact-bubble"
    : "agent-bubble compact-bubble";


            // Handle flight recommendations
            if (type === "flight_recommendation" && data) {
                renderFlightRecommendation(data, text);
                return;
            }

            // Regular text message
            const messageDiv = document.createElement("div");
            messageDiv.className = `flex ${alignment}`;

            let contentHTML = text
                .replace(/\n/g, "<br>")
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\*(.*?)\*/g, "<em>$1</em>");

            messageDiv.innerHTML = `
                <div class="${bubbleClass}">
                    ${contentHTML}
                </div>
            `;

            elements.chatHistory.appendChild(messageDiv);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }


        // Flight rendering functions
// Flight rendering functions
function renderFlightRecommendation(flightData, headerText) {
  const chatHistory = document.getElementById("chat-history");

  // Create agent bubble container
  const bubble = document.createElement("div");
  bubble.className = "agent-bubble compact-bubble";

  // Clone the hidden flight tabs template
  const tabsTemplate = document.getElementById("flight-tabs");
  const tabsClone = tabsTemplate.cloneNode(true);

  // ‚úÖ Fix possible reversed tab layout
  const tabButtonsContainer = tabsClone.querySelector(".tab-buttons, .flex");
  if (tabButtonsContainer) {
    tabButtonsContainer.classList.remove("flex-row-reverse", "justify-end", "space-x-reverse");
    tabButtonsContainer.classList.add("flex-row", "justify-start");
  }

  tabsClone.id = ""; // avoid duplicate IDs
  tabsClone.classList.remove("hidden");

  // Add header
  const header = document.createElement("div");
  header.className =
    "flex items-center text-[13px] font-medium text-white mb-2 rounded-md px-3 py-1.5 shadow-sm";
  header.style.background = "linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%)";
  header.innerHTML = `
    <span class="mr-2 text-white text-sm">‚úàÔ∏è</span>
    <span>${headerText}</span>
  `;

  bubble.appendChild(header);
  bubble.appendChild(tabsClone);


  // Wrap in chat message
  const messageWrapper = document.createElement("div");
  messageWrapper.className = "flex justify-start mb-4";
  const avatar = document.createElement("div");
  avatar.className =
    "w-8 h-8 rounded-full overflow-hidden shadow-sm flex items-center justify-center bg-white mr-3";
  avatar.innerHTML = `<img src="/static/person.png" alt="AI Travel Agent" class="object-contain w-7 h-7">`;
  messageWrapper.appendChild(avatar);
  messageWrapper.appendChild(bubble);
  chatHistory.appendChild(messageWrapper);
  chatHistory.scrollTop = chatHistory.scrollHeight;

  // Init tabs
  initLocalTabs(tabsClone);

  // === Determine trip type ===
  const tripType =
    flightData.tripType ||
    (flightData.inbound && flightData.inbound.length
      ? "roundTrip"
      : flightData.flights?.length > 1
      ? "multiCity"
      : "oneWay");

  // === Show/hide relevant tabs ===
  const tabButtons = tabsClone.querySelectorAll(".tab-btn");
  const tabContents = tabsClone.querySelectorAll(".tab-content");
  tabButtons.forEach(btn => (btn.style.display = "block"));
  tabContents.forEach(tab => (tab.style.display = "block"));

  if (tripType === "oneWay") {
    tabsClone.querySelector('[data-tab="tab2"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab3"]').style.display = "none";
    tabsClone.querySelector("#tab2").style.display = "none";
    tabsClone.querySelector("#tab3").style.display = "none";
  } else if (tripType === "roundTrip") {
    tabsClone.querySelector('[data-tab="tab1"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab3"]').style.display = "none";
    tabsClone.querySelector("#tab1").style.display = "none";
    tabsClone.querySelector("#tab3").style.display = "none";
  } else if (tripType === "multiCity") {
    tabsClone.querySelector('[data-tab="tab1"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab2"]').style.display = "none";
    tabsClone.querySelector("#tab1").style.display = "none";
    tabsClone.querySelector("#tab2").style.display = "none";
  }

  // === Render One-Way Flights ===
  if (tripType === "oneWay") {
    const oneWayTab = tabsClone.querySelector("#tab1");
    const offers = flightData.offers || flightData.flights?.[0]?.offers || [];
offers.sort((a, b) => a.stops - b.stops);
    const offersHTML = offers
  .map(
    (offer, index) => `
      <div class="border-2 border-gray-200 rounded-xl p-3 shadow bg-white mb-4 flight-card"
           data-id="ow_${index}"
           data-flight='${JSON.stringify(offer)}'>
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <img 
              src="${offer.logoUrl || `https://content.airhex.com/content/logos/airlines_${offer.carrierCode}_100_100_s.png`}" 
              alt="${offer.carrierName || 'Airline'} logo"
              class="w-6 h-6 object-contain rounded bg-gray-50"
              onerror="this.style.display='none'">
            <div class="text-gray-800">
              <div class="font-semibold text-[13px] leading-tight">
                ${offer.carrierName || ''}
              </div>
              <div class="text-[11px] text-gray-500 tracking-tight mt-[1px]">
                ${offer.flightNumber || ''}
              </div>
            </div>
          </div>
          <div class="text-right text-green-600 font-bold text-[14px]">
            ${offer.price?.total || ''} ${offer.price?.currency || ''}
          </div>
        </div>



            <div class="flex justify-between mt-2 text-gray-700 text-[12px]">
              <div>
                <p><span class="font-medium">${offer.departureTime || ''}</span> Depart</p>
                <p class="text-gray-500 text-[11px]">${offer.departureDate || ''}</p>
                <p class="text-gray-500">${offer.origin || ''}</p>
              </div>
              <div class="text-center">
                <p>‚úàÔ∏è ${offer.flightDuration || ''}</p>
                <p class="${offer.stops > 0 ? 'text-orange-600' : 'text-green-600'}">
                  ${offer.stops > 0 
                      ? `${offer.stops} stop${offer.stops > 1 ? 's' : ''} via ${offer.via || ''}` 
                      : 'Non-stop'}
                </p>
              </div>
              <div class="text-right">
                <p><span class="font-medium">${offer.arrivalTime || ''}</span> Arrive</p>
                <p class="text-gray-500 text-[11px]">${offer.arrivalDate || ''}</p>
                <p class="text-gray-500">${offer.destination || ''}</p>
              </div>
            </div>

            <div class="mt-1 pt-1 text-[11px] text-gray-500 border-t">
              <span>${offer.baggage || '‚Äî'} ‚Ä¢ ${offer.cabin || 'Economy'}</span>
              <div class="fare-breakdown text-[10px] text-gray-600 mt-1 ml-1 leading-tight flex flex-wrap items-center">
                ${
                  [
                    offer.fare_breakdown?.adults?.count > 0
                      ? `üë®‚Äçüíº ${offer.fare_breakdown.adults.count}√óAdult = ${offer.fare_breakdown.adults.total} ${offer.fare_breakdown.currency}`
                      : '',
                    offer.fare_breakdown?.children?.count > 0
                      ? `üßí ${offer.fare_breakdown.children.count}√óChild = ${offer.fare_breakdown.children.total} ${offer.fare_breakdown.currency}`
                      : '',
                    offer.fare_breakdown?.infants?.count > 0
                      ? `üë∂ ${offer.fare_breakdown.infants.count}√óInfant = ${offer.fare_breakdown.infants.total} ${offer.fare_breakdown.currency}`
                      : ''
                  ].filter(Boolean).join(' ‚Ä¢ ')
                }
              </div>
            </div>
          </div>`
      )
      .join('');

oneWayTab.innerHTML =
  offersHTML || "<p class='text-gray-500 text-sm'>No one-way flights found.</p>";

// ‚≠ê Correct Flight Card Click Handler (NO cloneNode)
oneWayTab.querySelectorAll(".flight-card").forEach(card => {

    // Prevent multiple listeners
    if (card.dataset.bound === "1") return;
    card.dataset.bound = "1";

    // Add stable click listener
    card.addEventListener("click", () => {
        const flight = JSON.parse(card.dataset.flight);
        toggleSelection(flight, card);
    });
});


// ‚≠ê ADD SELECT-ALL TOGGLE FOR ONE-WAY
addSelectAllToggle(oneWayTab);

return;




// ‚≠ê FIXED SELECT ALL / DESELECT ALL FOR MULTI-CITY ‚≠ê
setTimeout(() => {
  const selectAllBtn = document.createElement("button");
  selectAllBtn.id = "select-all-flights-global";
  selectAllBtn.textContent = "Select All Flights";
  selectAllBtn.className =
    "bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";

  selectAllBtn.addEventListener("click", () => {

    const allCards = tabsClone.querySelectorAll(".flight-card");

    // Detect if all are selected
    const allSelected = [...allCards].every(card =>
      card.classList.contains("selected")
    );

    // === UNSELECT ALL ===
    if (allSelected) {
      window.appState.selectedFlights = [];

      allCards.forEach(card => {
        card.classList.remove("selected", "ring-2", "ring-blue-500", "bg-blue-50");
      });

      updateSelectionSummary();
      selectAllBtn.textContent = "Select All Flights";
      return;
    }

    // === SELECT ALL ===
    window.appState.selectedFlights = []; // Reset

    allCards.forEach(card => {
      const flight = JSON.parse(card.dataset.flight);
      const id = card.dataset.id;

      // Add flight with unique ID
      window.appState.selectedFlights.push({ id, ...flight });

      card.classList.add("selected", "ring-2", "ring-blue-500", "bg-blue-50");
    });

    updateSelectionSummary();
    selectAllBtn.textContent = "Deselect All Flights";
  });

  bubble.appendChild(selectAllBtn);
}, 80);




return;
}


// === Render Round-Trip / Multi-City ===
const tabButtonsContainer2 = tabsClone.querySelector(".flex");
const contentWrapper = tabsClone;

// Remove preset tabs
tabButtonsContainer2.innerHTML = "";
["#tab1", "#tab2", "#tab3"].forEach(sel => {
  const el = tabsClone.querySelector(sel);
  if (el) el.remove();
});

// Normalize segment order
let segments = flightData.flights || [];
if (segments.length === 2) {
  const [seg1, seg2] = segments;
  const isReversed =
    seg1.origin &&
    seg2.destination &&
    seg1.origin === seg2.destination &&
    seg1.destination === seg2.origin;
  if (isReversed) segments = [seg2, seg1];
}

segments = segments.slice().sort(
  (a, b) => new Date(a.departureDate) - new Date(b.departureDate)
);

// === Build tabs & flights ===
segments.forEach((segment, index) => {
  const segNum = index + 1;
  const origin = segment.origin || segment.offers?.[0]?.origin || "N/A";
  const destination =
    segment.destination || segment.offers?.[0]?.destination || "N/A";
  const tabId = `segment-tab-${segNum}`;

  // Tab Button
  const button = document.createElement("button");
  button.className =
    "tab-btn flex-1 py-2 text-center font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent focus:outline-none";
  button.dataset.tab = tabId;
  button.textContent = `${origin} ‚Üí ${destination}`;
  tabButtonsContainer2.appendChild(button);

  // Tab Content
  const tabDiv = document.createElement("div");
  tabDiv.id = tabId;
  tabDiv.className = "tab-content p-4 hidden";

  const offers = segment.offers || [];
offers.sort((a, b) => a.stops - b.stops);
const offersHTML = offers
  .map(
    (offer, index) => `
<div class="border-2 border-gray-200 rounded-xl p-3 shadow bg-white mb-4 flight-card"
     data-id="mc_${segNum}_${index}"
     data-flight='${JSON.stringify(offer)}'>

        <!-- Airline + Price -->
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <img
              src="${offer.logoUrl || `https://content.airhex.com/content/logos/airlines_${offer.carrierCode}_100_100_s.png`}"
              alt="${offer.carrierName || "Airline"} logo"
              class="w-6 h-6 object-contain rounded bg-gray-50"
              onerror="this.style.display='none'">
            <div class="text-gray-800">
              <div class="font-semibold text-[13px] leading-tight">
                ${offer.carrierName || ""}
              </div>
              <div class="text-[11px] text-gray-500 tracking-tight mt-[1px]">
                ${offer.flightNumber || ""}
              </div>
            </div>
          </div>

          <div class="text-right text-green-600 font-bold text-[14px]">
            ${offer.price?.total || ""} ${offer.price?.currency || ""}
          </div>
        </div>

        <!-- Timing Row -->
        <div class="flex justify-between mt-2 text-gray-700 text-[12px]">
          <div>
            <p><span class="font-medium">${offer.departureTime || ""}</span> Depart</p>
            <p class="text-gray-500 text-[11px]">${offer.departureDate || ""}</p>
            <p class="text-gray-500">${offer.origin || ""}</p>
          </div>

          <div class="text-center">
            <p>‚úàÔ∏è ${offer.flightDuration || ""}</p>
            <p class="${offer.stops > 0 ? "text-orange-600" : "text-green-600"}">
              ${
                offer.stops > 0
                  ? `${offer.stops} stop${offer.stops > 1 ? "s" : ""} via ${offer.via || ""}`
                  : "Non-stop"
              }
            </p>
          </div>

          <div class="text-right">
            <p><span class="font-medium">${offer.arrivalTime || ""}</span> Arrive</p>
            <p class="text-gray-500 text-[11px]">${offer.arrivalDate || ""}</p>
            <p class="text-gray-500">${offer.destination || ""}</p>
          </div>
        </div>

        <!-- Fare Breakdown + Baggage -->
        <div class="mt-1 pt-1 text-[11px] text-gray-500 border-t">
          <span>${offer.baggage || "‚Äî"} ‚Ä¢ ${offer.cabin || "Economy"}</span>

          <div class="fare-breakdown text-[10px] text-gray-600 mt-1 ml-1 leading-tight flex flex-wrap items-center">
            ${
              [
                offer.fare_breakdown?.adults?.count > 0
                  ? `üë®‚Äçüíº ${offer.fare_breakdown.adults.count}√óAdult = ${offer.fare_breakdown.adults.total} ${offer.fare_breakdown.currency}`
                  : "",
                offer.fare_breakdown?.children?.count > 0
                  ? `üßí ${offer.fare_breakdown.children.count}√óChild = ${offer.fare_breakdown.children.total} ${offer.fare_breakdown.currency}`
                  : "",
                offer.fare_breakdown?.infants?.count > 0
                  ? `üë∂ ${offer.fare_breakdown.infants.count}√óInfant = ${offer.fare_breakdown.infants.total} ${offer.fare_breakdown.currency}`
                  : ""
              ]
                .filter(Boolean)
                .join(" ‚Ä¢ ")
            }
          </div>
        </div>

      </div>`
  )
  .join("");



  tabDiv.innerHTML =
    offersHTML ||
    `<p class="text-gray-500 text-sm">No flights found for ${origin} ‚Üí ${destination}</p>`;

  contentWrapper.appendChild(tabDiv);

  // Enable click selection
  tabDiv.querySelectorAll(".flight-card").forEach(card => {
card.addEventListener("click", () => {
  const flight = JSON.parse(card.dataset.flight);
  toggleSelection(flight, card);
});

  });
});

// ‚≠ê GLOBAL SELECT ALL BUTTON (CORRECT, SAFE)
const globalSelectAllBtn = document.createElement("button");
globalSelectAllBtn.textContent = "Select All Flights";
globalSelectAllBtn.className =
  "bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";

globalSelectAllBtn.addEventListener("click", () => {
  const allCards = tabsClone.querySelectorAll(".flight-card");

  const allSelected = [...allCards].every(card =>
    card.classList.contains("ring-2")
  );

  if (allSelected) {
    // DESELECT ALL
    window.appState.selectedFlights = [];
    allCards.forEach(card =>
      card.classList.remove("ring-2", "ring-blue-500", "bg-blue-50")
    );
    globalSelectAllBtn.textContent = "Select All Flights";
    updateSelectionSummary();
    return;
  }

  // SELECT ALL
  window.appState.selectedFlights = [];
  allCards.forEach(card => {
    const flight = JSON.parse(card.dataset.flight);
    window.appState.selectedFlights.push(flight);
    card.classList.add("ring-2", "ring-blue-500", "bg-blue-50");
  });

  globalSelectAllBtn.textContent = "Deselect All Flights";
  updateSelectionSummary();
});

// Add global select-all below whole bubble
bubble.appendChild(globalSelectAllBtn);

// Initialize tabs
if (typeof initLocalTabs === "function") initLocalTabs(tabsClone);
const firstTab = tabsClone.querySelector(".tab-btn");
if (firstTab) firstTab.click();
}


function getFlightId(f) {
    return [
        f.flightNumber,
        f.origin,
        f.destination,
        f.departureDate,
        f.departureTime
    ].join("_");
}

function toggleSelection(flight, card) {
    const id = card.dataset.id;

    if (!id) {
        console.error("CARD HAS NO ID ‚Üí Cannot track selection");
        return;
    }

    const existingIndex = window.appState.selectedFlights.findIndex(f => f.id === id);

    if (existingIndex !== -1) {
        // REMOVE
        window.appState.selectedFlights.splice(existingIndex, 1);
        card.classList.remove("selected", "ring-2", "ring-blue-500", "bg-blue-50");

    } else {
        // ADD
        window.appState.selectedFlights.push({ id, ...flight });
        card.classList.add("selected", "ring-2", "ring-blue-500", "bg-blue-50");
    }

    updateSelectionSummary();
}







function updateSelectionSummary() {
    const count = window.appState.selectedFlights.length;
    const badge = document.getElementById("cart-count");
    const list = document.getElementById("cart-items");

    // Update badge
    badge.textContent = count > 0 ? count : "";
    badge.style.display = count > 0 ? "flex" : "none";

    // Clear list
    list.innerHTML = "";

    if (count === 0) {
        list.innerHTML = `<p class="text-gray-500 text-sm">No flights selected.</p>`;
        return;
    }

    // üî• Get markup %
    const markup = Number(document.getElementById("markup-select")?.value || 0);

    window.appState.selectedFlights.forEach(f => {

        // Fare breakdown
        const fb = f.fare_breakdown || {};
        const lines = [];

        // üî• Apply markup to each breakdown block
if (fb.adults?.count) {
    const markedAdult = applyMarkup(fb.adults.total, markup);
    lines.push(`üßë‚Äçüíº ${fb.adults.count}√óAdult = ${markedAdult} ${fb.currency || "AED"}`);
}

if (fb.children?.count) {
    const markedChild = applyMarkup(fb.children.total, markup);
    lines.push(`üßí ${fb.children.count}√óChild = ${markedChild} ${fb.currency || "AED"}`);
}

if (fb.infants?.count) {
    const markedInfant = applyMarkup(fb.infants.total, markup);
    lines.push(`üë∂ ${fb.infants.count}√óInfant = ${markedInfant} ${fb.currency || "AED"}`);
}


        const fareBreakdownHTML = lines
            .map(line => `<div class="flex items-center gap-1 ml-1">${line}</div>`)
            .join("");

        // üî• Total with markup
        const markedTotal = applyMarkup(f.price?.total, markup);

        // Build card
        const card = document.createElement("div");
        card.className =
            "p-3 mb-3 border rounded-lg bg-white shadow-sm text-[12px] leading-tight";

        card.innerHTML = `
            <!-- Airline Row -->
            <div class="flex items-center gap-2 mb-2">
                <img 
                    src="${f.logoUrl || `https://content.airhex.com/content/logos/airlines_${f.carrierCode}_100_100_s.png`}"
                    class="w-6 h-6 object-contain bg-gray-50 rounded"
                    onerror="this.style.display='none'"
                >
                <div class="text-[12px]">
                    <div class="font-semibold">${f.carrierName || "Airline"}</div>
                    <div class="text-[11px] text-gray-500">${f.flightNumber || ""}</div>
                </div>
            </div>

            <!-- Times + Dates -->
            <div class="flex justify-between items-start text-[12px] mt-1">

                <div class="text-left">
                    <div class="font-semibold">${f.departureTime || ""}</div>
                    <div class="text-gray-600 text-[11px] mt-[1px]">${f.departureDate || ""}</div>
                    <div class="text-[11px] text-gray-500">${f.origin || ""}</div>
                </div>

                <div class="text-gray-400 mt-1">‚Üí</div>

                <div class="text-right">
                    <div class="font-semibold">${f.arrivalTime || ""}</div>
                    <div class="text-gray-600 text-[11px] mt-[1px]">${f.arrivalDate || ""}</div>
                    <div class="text-[11px] text-gray-500">${f.destination || ""}</div>
                </div>
            </div>

            <!-- Baggage + Cabin -->
            <div class="flex justify-between text-[11px] mt-2">
                <div>üõÑ ${f.baggage || "‚Äî"}</div>
                <div class="flex items-center">
                    <span class="text-[10px] mr-1">‚óé</span>
                    ${f.cabin || "ECONOMY"}
                </div>
            </div>

            <!-- Fare Breakdown -->
            ${fareBreakdownHTML ? `<div class="mt-2 text-[11px] leading-tight">${fareBreakdownHTML}</div>` : ""}

            <!-- Price (Total with markup) -->
            <div class="text-green-700 font-bold text-right text-[15px] mt-2">
                ${markedTotal} ${f.price?.currency || ""}
            </div>
        `;

        list.appendChild(card);
    });
}
document.addEventListener("change", (e) => { if (e.target.id === "markup-select") { updateSelectionSummary(); } });






function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr; // fallback if invalid
    const day = String(d.getDate()).padStart(2, "0");
    const month = d.toLocaleString("en", { month: "short" });
    const year = d.getFullYear();
    return `${day} ${month} ${year}`;
  } catch {
    return dateStr;
  }
}


document.addEventListener("DOMContentLoaded", () => {
  const copyBtn = document.getElementById("multi-copy-btn");
  const userInput = document.getElementById("user-input");

  if (!copyBtn) return;

  copyBtn.addEventListener("click", (event) => {
    event.preventDefault();
    event.stopPropagation();

    // prevent input focus
    window.__block_auto_focus = true;
    if (userInput) userInput.blur();

    const selected = window.appState.selectedFlights || [];
    if (selected.length === 0) {
      alert("No flights selected yet!");
      return;
    }

    const sorted = selected.slice().sort(
      (a, b) => new Date(a.departureDate) - new Date(b.departureDate)
    );

    // üî• GET MARKUP %
    const markup = Number(document.getElementById("markup-select")?.value || 0);

    let message = "=== SELECTED FLIGHTS ===\n\n";

    sorted.forEach((f, i) => {

      const firstOrigin = sorted[0].origin;
      const label = f.origin === firstOrigin ? "Outbound" : "Inbound";

      const stopInfo =
        f.stops > 0
          ? `${f.stops} stop${f.stops > 1 ? "s" : ""} via ${f.via}`
          : "Non-stop";

      // üî• APPLY MARKUP TO TOTAL ONLY
      const markedTotal = applyMarkup(f.price.total, markup);

      message += `FLIGHT ${i + 1}: ${label}\n`;
      message += `‚Ä¢ ${f.carrierName || "Airline"} ${f.flightNumber || ""}\n`;
      message += `‚Ä¢ Route: ${f.origin} ‚Üí ${f.destination}\n`;
      message += `‚Ä¢ Departure: ${f.departureTime} (${formatDate(f.departureDate)})\n`;
      message += `‚Ä¢ Arrival: ${f.arrivalTime} (${formatDate(f.arrivalDate)})\n`;
      message += `‚Ä¢ ${stopInfo}\n`;
      message += `‚Ä¢ Price (for all pax): ${markedTotal} ${f.price.currency}\n\n`;
    });

    navigator.clipboard.writeText(message).catch(err => {
      console.error("Clipboard copy failed", err);
    });
  });
});






// Extract dates that the backend actually used
function getBackendDates(flightData) {

            const backendDates = {
                segment1: null,
                segment2: null
            };

            if (flightData.flights && Array.isArray(flightData.flights)) {
                flightData.flights.forEach((segment, index) => {
                    const flight = segment.offers?.[0];
                    if (flight && flight.departureDate) {
                        backendDates[`segment${index + 1}`] = formatDateForDisplay(flight.departureDate);
                    }
                });
            }

            return backendDates;
        }

        // Check if backend used different dates than requested
        function checkBackendDateMismatch(requestedDates, backendDates) {
            if (!requestedDates.segment1 || !backendDates.segment1) return false;
            
            const requestedOutbound = requestedDates.segment1.toUpperCase();
            const requestedReturn = requestedDates.segment2?.toUpperCase();
            const backendOutbound = backendDates.segment1?.toUpperCase();
            const backendReturn = backendDates.segment2?.toUpperCase();
            
            return (requestedOutbound !== backendOutbound) || (requestedReturn !== backendReturn);
        }

        // Enhanced flight section with better date comparison
        function renderFlightSection(flights, title, color, requestedDate, segmentNumber) {
            if (!flights || flights.length === 0) {
                return `
                    <div class="flight-section">
                        <div class="flight-header" style="color: ${color};">${title}</div>
                        <div class="compact-flight-card">
                            <div class="text-center text-gray-500 py-6">
                                <i class="fas fa-plane-slash text-2xl mb-2 opacity-50"></i>
                                <div>No flights available for this segment</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let html = `
                <div class="flight-section">
                    <div class="flight-header" style="color: ${color};">
                        ${title}
                        ${requestedDate ? `
                            <span class="text-xs font-normal text-gray-500 ml-2">
                                (Requested: ${requestedDate})
                            </span>
                        ` : ''}
                    </div>
            `;

            flights.forEach((flight, index) => {
                html += renderFlightCard(flight, requestedDate, index, segmentNumber);
            });

            html += `</div>`;
            return html;
        }



        // Enhanced flight card with detailed date information
        function renderFlightCard(flight, requestedDate, index, segmentNumber) {
            const departureDate = formatDateForDisplay(flight.departureDate);
            const arrivalDate = formatDateForDisplay(flight.arrivalDate);
            const formattedRequestedDate = formatDateForDisplay(requestedDate);
            
            const hasDateMismatch = formattedRequestedDate && departureDate !== formattedRequestedDate;
            const isReturnFlight = segmentNumber === 2;
            
            // Calculate duration if not provided
            let duration = flight.duration;
            if (!duration && flight.departureTime && flight.arrivalTime) {
                duration = calculateDuration(flight.departureTime, flight.arrivalTime);
            }

            return `
                <div class="compact-flight-card ${hasDateMismatch ? 'date-mismatch' : ''} ${isReturnFlight ? 'return-flight' : ''}">
                    ${hasDateMismatch ? `
                        <div class="date-mismatch-banner">
                            <i class="fas fa-calendar-exclamation mr-1"></i>
                            Showing: ${departureDate} (Requested: ${formattedRequestedDate})
                        </div>
                    ` : ''}
                    
                    <div class="flight-airline">
                        <div class="airline-logo ${isReturnFlight ? 'return-logo' : ''}">
                            ${(flight.carrierCode || 'FL').substring(0, 2)}
                        </div>
                        <div>
                            <div class="airline-name">${flight.carrierName || 'Airline'}</div>
                            <div class="flight-number">
                                <i class="fas fa-plane mr-1"></i>
                                ${flight.flightNumber || 'N/A'}
                            </div>
                        </div>
                    </div>

                    <div class="flight-route">
                        <div class="route-segment">
                            <div class="route-time">${flight.departureTime || '--:--'}</div>
                            <div class="route-date ${hasDateMismatch ? 'text-red-600 font-bold' : ''}">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                ${departureDate}
                            </div>
                            <div class="route-airport">
                                <i class="fas fa-plane-departure mr-1 text-blue-500"></i>
                                ${flight.origin || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="route-connector">
                            <div class="flight-duration">
                                <i class="fas fa-clock mr-1"></i>
                                ${duration || 'N/A'}
                            </div>
                            <div class="connector-line"></div>
                            <div class="flight-stops">
                                ${flight.stops === 0 ? 
                                    '<i class="fas fa-arrow-right mr-1"></i> Non-stop' : 
                                    `<i class="fas fa-map-marker-alt mr-1"></i> ${flight.stops} stop${flight.stops > 1 ? 's' : ''}`
                                }
                            </div>
                        </div>
                        
                        <div class="route-segment">
                            <div class="route-time">${flight.arrivalTime || '--:--'}</div>
                            <div class="route-date">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                ${arrivalDate}
                            </div>
                            <div class="route-airport">
                                <i class="fas fa-plane-arrival mr-1 text-green-500"></i>
                                ${flight.destination || 'N/A'}
                            </div>
                        </div>
                    </div>

                    <div class="flight-price">
                        <div class="price-amount">
                            <i class="fas fa-tag mr-1"></i>
                            ${flight.price?.total || 'N/A'} ${flight.price?.currency || 'AED'}
                        </div>
                        <div class="price-label">Total per passenger ‚Ä¢ Includes taxes</div>
                    </div>

                    <div class="flight-meta">
                        <div class="flight-class">
                            <i class="fas fa-chair mr-1"></i>
                            ${flight.cabin || 'Economy'}
                        </div>
                                         </div>
                </div>
            `;
        }

        // Helper function to calculate duration
        function calculateDuration(departureTime, arrivalTime) {
            if (!departureTime || !arrivalTime) return 'N/A';
            
            try {
                const [depHours, depMinutes] = departureTime.split(':').map(Number);
                const [arrHours, arrMinutes] = arrivalTime.split(':').map(Number);
                
                let totalMinutes = (arrHours * 60 + arrMinutes) - (depHours * 60 + depMinutes);
                
                // Handle next day arrival
                if (totalMinutes < 0) {
                    totalMinutes += 24 * 60;
                }
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                return `${hours}h ${minutes}m`;
            } catch (error) {
                return 'N/A';
            }
        }

        // Enhanced date extraction for round trip queries
        function extractRequestedDates(query) {
            const dates = {};
            
            // Match round trip patterns like "AUH-BOM-AUH 12 NOV,19 NOV"
            const roundTripPattern = /(\w{3})-(\w{3})-(\w{3})\s+([^,]+),\s*([^,]+)/i;
            const roundTripMatch = query.match(roundTripPattern);
            
            if (roundTripMatch) {
                dates.segment1 = roundTripMatch[4].trim().toUpperCase();
                dates.segment2 = roundTripMatch[5].trim().toUpperCase();
                return dates;
            }
            
            // Match multi-city patterns
            const multiCityPattern = /(\d{1,2}\s+(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*\d{0,4})/gi;
            const dateMatches = query.match(multiCityPattern);
            
            if (dateMatches) {
                dateMatches.forEach((date, index) => {
                    dates[`segment${index + 1}`] = date.toUpperCase().replace(/\s+/g, ' ');
                });
            }
            
            return dates;
        }

        // Helper function to format dates consistently
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return 'N/A';
            
            // Handle different date formats
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }
            
            // Already formatted date
            return dateStr.toUpperCase();
        }


       
// üîµ Updates the cart badge count safely
function updateCartCount(count) {
    const cartCountEl = document.getElementById("cart-count");
    if (!cartCountEl) return;    // Prevent crash if icon not loaded

    if (count > 0) {
        cartCountEl.textContent = count;
        cartCountEl.classList.remove("hidden");
    } else {
        cartCountEl.classList.add("hidden");
    }
}


        // API Communication
        async function callGenerativeAgent(query) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(CONFIG.BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-Id': window.appState.currentSessionId
                        },
                        body: JSON.stringify({ query: query })
                    });

                    if (response.ok) {
                        window.appState.retryCount = 0;
                        return await response.json();
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt < CONFIG.MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                    }
                }
            }
            
            throw lastError;
        }

        // Event Handlers
async function handleUserInput() {
  const query = elements.userInput.value.trim();
  if (!query) return;

  elements.userInput.value = '';
  elements.sendBtn.disabled = true;
  showLoading(true);

  try {
    await saveMessage(query, 'user');

    // ‚≠ê‚≠ê‚≠ê CUSTOM COMMANDS FOR SELECTED FLIGHTS ‚≠ê‚≠ê‚≠ê
    const selected = window.appState.selectedFlights || [];

// User types ‚Äúquote‚Äù
if (/quote|quotation|price summary|cost/i.test(query)) {
  if (selected.length === 0) {
    saveMessage("No flights selected yet.", "agent");
  } else {
    document.getElementById("quote-form-modal").classList.remove("hidden");
  }
  showLoading(false);
  elements.sendBtn.disabled = false;
  return;
}


    // === Itinerary ===
    if (/itinerary|itenary|itin|plan my trip|schedule/i.test(query)) {
      if (selected.length === 0) {
        saveMessage("No flights selected yet.", "agent");
      } else {
        generateItinerary(selected);
      }
      showLoading(false);
      elements.sendBtn.disabled = false;
      return;
    }

    // === Summary ===
    if (/summary|show my flights|view selection|selected flights/i.test(query)) {
      if (selected.length === 0) {
        saveMessage("No flights selected yet.", "agent");
      } else {
        generateSummary(selected);
      }
      showLoading(false);
      elements.sendBtn.disabled = false;
      return;
    }

    // ‚≠ê‚≠ê‚≠ê END CUSTOM BLOCK ‚≠ê‚≠ê‚≠ê

    let tempText = "Processing your request...";
    if (/\b(flight|fly|air|return|trip|ticket|airport|departure|arrival)\b/i.test(query)) {
      tempText = "Searching for the best flights...";
    } else if (/\b(weather|temperature|forecast|climate)\b/i.test(query)) {
      tempText = "Checking the latest weather information...";
    } else if (/\b(hotel|resort|stay|accommodation|room)\b/i.test(query)) {
      tempText = "Finding the best hotel options...";
    } else if (/\b(activity|tour|things? to do|sightseeing|attraction)\b/i.test(query)) {
      tempText = "Looking for fun activities...";
    } else if (/\b(time|timezone|local time|clock)\b/i.test(query)) {
      tempText = "Checking the current time...";
    } else if (/\b(agency|company|movie|actor|person|brand|event)\b/i.test(query)) {
      tempText = "Searching for details...";
    } else if (/\b(hi|hello|hey|thanks|thank you)\b/i.test(query)) {
      tempText = "Hi there!";
    }

    await saveMessage(tempText, 'agent', 'text', null);

    // 3Ô∏è‚É£ Send query to backend
    const agentResponse = await callGenerativeAgent(query);

    // 4Ô∏è‚É£ Remove temporary bubble
    const tempMsg = [...elements.chatHistory.querySelectorAll('.agent-bubble')]
      .find(el => el.textContent.trim() === tempText);
    if (tempMsg) tempMsg.remove();

    // 5Ô∏è‚É£ Unified handler
    handleSearchResponse(agentResponse);
    return;

  } catch (error) {
    console.error('Agent communication failed:', error);
    const errorMessage = `I encountered an issue while processing your request. Please try again. (Error: ${error.message})`;
    await saveMessage(errorMessage, 'agent', 'text', null);
  } finally {
    showLoading(false);
    elements.sendBtn.disabled = false;

    if (!window.__block_auto_focus) elements.userInput.focus();
    window.__block_auto_focus = false;
  }
}






        // Event Listeners
document.querySelectorAll('.quick-action').forEach(btn => {
    btn.addEventListener('click', function() {

        // ‚ùó Skip for Copy Selected Flights button
        if (this.id === "multi-copy-btn") return;

        const query = this.getAttribute('data-query') || this.textContent;
        elements.userInput.value = query;
        elements.userInput.focus();
    });
});


        elements.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !elements.sendBtn.disabled) {
                handleUserInput();
            }
        });

        elements.sendBtn.addEventListener('click', handleUserInput);


// üî• FIX: Prevent auto-writing into the input when clicking copy buttons
document.addEventListener("click", (e) => {
    const copyBtn = e.target.closest("#multi-copy-btn");

    if (copyBtn) {
        const input = document.getElementById("user-input");
        if (input) {
            input.blur();
            input.setSelectionRange(0, 0);
        }
    }
});

// FIX: Remove paste restrictions because multi-copy-btn no longer exists
document.getElementById("user-input")?.addEventListener("paste", () => {});


// ‚ùå OLD BUTTON REMOVED ‚Äî DO NOT ATTACH LISTENERS
// elements.confirmBtn DOES NOT EXIST ANYMORE
// So we delete this whole block
// ----------------------------------------------------
// (REMOVED)


// ‚úÖ INITIALIZE SYSTEM SAFELY
document.addEventListener('DOMContentLoaded', function () {
    try {
        initFirebaseAndAuth().catch(console.error);
    } catch (e) {
        console.warn("Firebase init skipped:", e);
    }

    const input = document.getElementById("user-input");
    if (input) input.focus();

    console.log("AI Travel Agent initialized successfully");
});


// ----------------------------------------------------
// ‚≠ê GLOBAL MENU HANDLER (SAFE)
// ----------------------------------------------------
window.handleMenuSelection = async function (optionId) {
    try {
        const response = await fetch("http://localhost:5000/api/flow", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-Id": window.appState.currentSessionId
            },
            body: JSON.stringify({ selected: optionId })
        });

        const result = await response.json();
        await saveMessage(result.text, "agent", result.type, result.data);
    } catch (error) {
        console.error("Menu selection failed:", error);
        showError("Sorry, something went wrong. Please try again.");
    }
};

function initLocalTabs(tabContainer) {
  const buttons = tabContainer.querySelectorAll('.tab-btn');
  const contents = tabContainer.querySelectorAll('.tab-content');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Remove active from all in this container
      buttons.forEach(b => b.classList.remove('active'));
      contents.forEach(c => c.classList.add('hidden'));

      // Activate only selected
      btn.classList.add('active');
      const targetId = btn.dataset.tab;
      const target = tabContainer.querySelector(`#${targetId}`);
      if (target) target.classList.remove('hidden');
    });
  });
}

const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

// ‚úÖ Auto-expand while typing
userInput.addEventListener("input", () => {
  userInput.style.height = "auto";
  userInput.style.height = Math.min(userInput.scrollHeight, 120) + "px";
});

// ‚úÖ Clean reset after sending
function resetInput() {
  userInput.value = "";
  userInput.style.height = "44px";      // restore exact base height
  userInput.blur();                     // prevent cursor artifacts
}

// ‚úÖ Click send
sendBtn.addEventListener("click", () => {
  // ... your existing sendMessage() logic ...
  setTimeout(resetInput, 50);           // small delay ensures layout flush
});

// ‚úÖ Enter = send, Shift+Enter = newline
userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});



// Toggle Cart Panel
document.getElementById("cart-float-btn").addEventListener("click", () => {
  const panel = document.getElementById("cart-panel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
});

// Update airplane badge count
function updateCartBadge() {
  const badge = document.getElementById("cart-count");
  const count = window.appState.selectedFlights.length;

  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

// Hook into selection summary
const oldUpdate = updateSelectionSummary;
updateSelectionSummary = function() {
  oldUpdate();
  updateCartBadge();
};

function showHotelResults() {
    document.getElementById("hotel-results-window").classList.remove("hidden");
}

function closeHotelResults() {
    document.getElementById("hotel-results-window").classList.add("hidden");
}

function clearHotelResults() {
    document.getElementById("hotel-results-content").innerHTML = "";
}

function updateHotelCart() {

    const container = document.getElementById("cart-hotel-items");
    const block = document.getElementById("cart-hotels");

    const hotels = window.appState.selectedHotels || [];

    if (hotels.length === 0) {
        block.classList.add("hidden");
        return;
    }

    block.classList.remove("hidden");

    container.innerHTML = hotels.map(h => `
        <div class="border rounded p-2 shadow-sm text-xs">
            <div class="font-semibold">${h.name}</div>
            <div>${"‚≠ê".repeat(h.rating)}</div>
            <div>${h.checkIn} ‚Üí ${h.checkOut}</div>
            <div>${h.address}</div>
            <div class="font-bold text-green-700">
                ${h.price} ${h.currency}
            </div>
            <div class="text-gray-500">
    ${h.nights} night${h.nights > 1 ? "s" : ""}
</div>

        </div>
    `).join("");
}


function esc(str) {
    return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}


function renderHotelsFromBackend(hotels) {
    const chat = document.getElementById("chat-history");

    const bubble = document.createElement("div");
    bubble.className = "agent-bubble";

    bubble.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="w-8 h-8 rounded-full overflow-hidden bg-white shadow flex items-center justify-center">
                <img src="./static/person.png" class="object-contain w-7 h-7">
            </div>
            <div class="flex-1" id="hotel-bubble-content"></div>
        </div>
    `;

    const contentArea = bubble.querySelector("#hotel-bubble-content");

    hotels.forEach(info => {

        const images = info.images || [];
        const imageUrl = images.length ? images[0] : "./static/hotel-placeholder.jpg";

        // Room section like Booking.com
        const roomHTML = `
    <div class="text-sm font-semibold text-gray-800 mt-1">${esc(info.roomName || "Standard Room")}</div>
    <div class="text-xs text-gray-600">${esc(info.beds || "")}</div>

    <div class="text-xs text-green-700 mt-1">
        ${info.freeCancellation ? "‚úî Free cancellation<br>" : ""}
        ${info.noPrepayment ? "‚úî No prepayment needed ‚Äì pay at the property" : ""}
    </div>

    <div class="text-xs text-gray-600 mt-1">
        ${info.nights} night${info.nights > 1 ? "s" : ""}, 
        ${info.adults || 1} adult${(info.adults || 1) > 1 ? "s" : ""}
    </div>
`;


        // PRICE BLOCK ‚Äî now BELOW details
        const priceHTML = `
            <div class="mt-3 text-right">
                <div class="font-bold text-xl text-green-700 leading-tight whitespace-nowrap">
                    ${info.price.amount} ${info.price.currency}
                </div>
                <div class="text-xs text-gray-500 whitespace-nowrap leading-tight">
                    + taxes and charges
                </div>
            </div>
        `;

        // FINAL CARD
        contentArea.innerHTML += `
<div class="border border-gray-200 rounded-xl p-4 shadow-sm bg-white mb-4">

    <div class="flex">

        <!-- IMAGE -->
        <div class="relative w-28 h-28 rounded-lg overflow-hidden flex-shrink-0 mr-3">
            <img src="${esc(imageUrl)}"
                class="w-full h-full object-cover cursor-pointer"
                onclick="openMobileImageViewer('${esc(imageUrl)}')">
        </div>

        <!-- HOTEL TEXT -->
        <div class="flex flex-col flex-1">

            <!-- HOTEL NAME -->
            <div class="font-semibold text-base text-blue-700 leading-tight">
                ${esc(info.name)}
            </div>

            <!-- STARS -->
            <div class="text-yellow-500 text-xs mb-1">
                ${"‚≠ê".repeat(parseInt(info.rating || 0))}
            </div>

            <!-- MAP -->
            <div class="text-xs text-blue-600 underline mb-1"
                 onclick="openMap(${info.latitude}, ${info.longitude})">
                 Show on map
            </div>

            <!-- ROOM SECTION -->
            ${roomHTML}

            <!-- PRICE BLOCK BELOW (clean layout) -->
            ${priceHTML}

        </div>
    </div>

    <!-- BUTTON -->
<button 
    class="hotel-detail-btn bg-blue-700 text-white w-full py-2 mt-3 rounded-lg text-sm"
    data-info='${JSON.stringify(info)}'>
    See availability ‚Üí
</button>

</div>
        `;
    });

    chat.appendChild(bubble);
    chat.scrollTop = chat.scrollHeight;
}
document.addEventListener("click", e => {
    if (e.target.classList.contains("hotel-detail-btn")) {
        const raw = e.target.dataset.info;
        const info = JSON.parse(raw);
        openHotelDetails(info);
    }
});






function handleSearchResponse(response) {

    // TEXT
    if (response.type === "text") {
        addAgentMessage(response.text);
        return;
    }

    // FLIGHTS
    if (response.type === "flight_recommendation") {
                renderFlightRecommendation(response.data, response.text);
        return;
    }

    // HOTELS
    if (response.type === "hotels") {
        const hotels = response.data || [];
        if (hotels.length === 0) {
            addAgentMessage("No hotels found.");
            return;
        }

        renderHotelsFromBackend(hotels);
        return;
    }

    // DEFAULT
    addAgentMessage("I couldn‚Äôt find relevant information for that.");
}
function addAgentMessage(text) {
    return saveMessage(text, 'agent', 'text', null);
}


function mobileNext() {
    mobileIndex = (mobileIndex + 1) % mobileImages.length;
    document.getElementById("mobileImage").src = mobileImages[mobileIndex];
}

function mobilePrev() {
    mobileIndex = (mobileIndex - 1 + mobileImages.length) % mobileImages.length;
    document.getElementById("mobileImage").src = mobileImages[mobileIndex];
}

function closeMobileViewer() {
    document.getElementById("mobileImageViewer").classList.add("hidden");
}

function openHotelDetails(info) {
    const panel = document.getElementById("room-detail-view");
    const box = document.getElementById("room-detail-content");

    // Slide panel in
    panel.classList.remove("hidden");
    panel.classList.remove("translate-x-full");
    panel.classList.add("slide-in");

    // Show loading
    box.innerHTML = `
        <div class="text-center text-gray-600 mt-4">
            Loading room types for <b>${info.name}</b>...
        </div>
    `;

    // Fetch room types
    fetch("/api/hotel/rooms", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hotel_id: info.id })
    })
    .then(res => res.json())
    .then(data => {
        const rooms = data.rooms || [];

        if (!rooms.length) {
            box.innerHTML = `
                <div class="text-center text-red-600 mt-4">
                    No rooms available.
                </div>
            `;
            return;
        }

        box.innerHTML = rooms
            .map(r => {
                const roomImage = (r.image && r.image.trim() !== "")
                    ? r.image
                    : "https://source.unsplash.com/800x600/?hotel-room";

                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">

                        <div class="font-semibold text-lg text-blue-700 mb-2">
                            ${r.name}
                        </div>

                        <img src="${roomImage}"
                            class="w-full h-40 rounded-lg object-cover mb-3">

                        <div class="text-sm text-gray-700">${r.beds || ""}</div>

                        ${
                            r.free_cancellation
                                ? `<div class="text-sm text-green-600 mt-1">‚úî Free cancellation</div>`
                                : ""
                        }

                        <div class="text-xl font-bold text-green-700 mt-3">
                            ${r.price}
                        </div>

                        <button class="bg-blue-600 text-white mt-3 w-full py-2 rounded-lg">
                            Select room ‚Üí
                        </button>

                    </div>
                `;
            })
            .join("");
    })
    .catch(err => {
        console.error(err);
        box.innerHTML = `
            <div class="text-center text-red-600 mt-4">
                Failed to load room details.
            </div>
        `;
    });
}



document.getElementById("room-back-btn").onclick = () => {
    const panel = document.getElementById("room-detail-view");

    panel.classList.remove("slide-in");
    panel.classList.add("translate-x-full");

    setTimeout(() => panel.classList.add("hidden"), 250);
};


function closeHotelDetails() {
    document.getElementById("hotelDetailsModal").classList.add("hidden");
}

    </script>

<!-- Full-screen mobile image viewer -->
<div id="mobileImageViewer"
     class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
    <img id="mobileImage" class="max-h-full max-w-full object-contain rounded-lg shadow-lg">
</div>

<script>
function openMobileImageViewer(url) {
    document.getElementById("mobileImage").src = url;
    document.getElementById("mobileImageViewer").classList.remove("hidden");
}

function closeMobileImageViewer() {
    document.getElementById("mobileImageViewer").classList.add("hidden");
}

document.getElementById("mobileImageViewer")
    .addEventListener("click", closeMobileImageViewer);

function openMap(lat, lng) {
    if (!lat || !lng) return;
    window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
}







</script>

<!-- HOTEL ROOM DETAIL SLIDE-IN PANEL -->
<div id="room-detail-view"
     class="fixed top-0 right-0 w-96 h-full bg-white shadow-2xl border-l border-gray-300 hidden translate-x-full transition-all duration-300 z-50">

    <!-- HEADER -->
    <div class="p-4 border-b flex justify-between items-center bg-gray-100">
        <span class="font-semibold text-gray-800 text-lg">Room Details</span>
        <button id="room-back-btn" class="text-red-600 font-bold text-sm">‚úñ</button>
    </div>

    <!-- CONTENT -->
    <div id="room-detail-content" class="p-4 overflow-y-auto h-full">
        Loading...
    </div>
</div>


<div id="quote-form-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">
  <div class="bg-white p-4 rounded-xl shadow-lg w-[90%] max-w-sm mx-auto">
    
    <h2 class="text-lg font-semibold mb-3 text-center">Quote Details</h2>

    <label class="block text-sm font-medium mb-1">Customer Name</label>
    <input id="customerName" type="text" class="w-full p-2 border rounded-lg mb-3 text-sm">

    <label class="block text-sm font-medium mb-1">Passengers</label>

    <div id="passengerList">
      <div class="flex items-center gap-2 mb-2 passenger-row">
        <input type="text" class="flex-1 p-2 border rounded-lg passenger-name text-sm" placeholder="Passenger 1 Name">
        <select class="w-24 p-2 border rounded-lg passenger-type text-sm">
          <option value="Adult">Adult</option>
          <option value="Child">Child</option>
          <option value="Infant">Infant</option>
        </select>
      </div>
    </div>

    <button id="addPassengerBtn" class="text-blue-600 text-sm mb-3">+ Add Passenger</button>

    <label class="block text-sm font-medium mb-1">Phone</label>
    <input id="customerPhone" type="tel" class="w-full p-2 border rounded-lg mb-3 text-sm">

    <label class="block text-sm font-medium mb-1">Email</label>
    <input id="customerEmail" type="email" class="w-full p-2 border rounded-lg mb-4 text-sm">

    <div class="flex justify-end gap-2">
      <button id="cancelQuoteBtn" class="px-4 py-2 bg-gray-200 rounded-lg text-sm">Cancel</button>
      <button id="confirmQuoteBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Generate</button>
    </div>

  </div>
</div>


<div id="quote-display-modal"
     class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">

  <div class="bg-white w-[390px] max-h-[90vh] overflow-y-auto rounded-xl shadow-2xl p-5">

      <div class="text-center mb-4">
        <h2 class="text-xl font-bold text-indigo-700">‚úàÔ∏è Flight Quotation</h2>
        <p id="quote-ref" class="text-[11px] text-gray-500"></p>
      </div>

      <div id="quote-content" class="text-[13px] text-gray-800 space-y-4"></div>

      <div class="flex justify-between mt-4">
        <button onclick="closeQuoteModal()" class="px-4 py-2 bg-gray-200 rounded-lg text-sm">
          Close
        </button>
        <button onclick="copyQuote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm shadow">
          Copy
        </button>
      </div>

  </div>
</div>

<script>
function closeQuoteModal() {
  document.getElementById("quote-display-modal").classList.add("hidden");
}
</script>


</body>
</html>
