<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Agent - Your Smart Travel Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    


<style>
/* ======================================================
   AI Travel Agent ‚Äì Clean Compact UI (v3)
   Palette: Navy (#0B2C5E) + Gold (#B2924C) + Green (#1EAD64)
====================================================== */
#loading-indicator {
  display: none !important;
  visibility: hidden !important;
}

/* ---------- GLOBAL ---------- */
body {
  font-family: "Inter", "Poppins", sans-serif;
  font-size: 13px;
  background: #f8fafc;
  color: #333;
  line-height: 1.4;
  padding: 12px;
}

/* ---------- MAIN CONTAINER ---------- */
.compact-container {
  max-width: 420px;
  height: 640px;
  margin: 0 auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ---------- HEADER ---------- */
.compact-header {
  background: linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%);
  color: #fff;
  padding: 16px 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.compact-header h1 {
  font-size: 17px;
  font-weight: 700;
  margin: 0;
}
.compact-header p {
  font-size: 12px;
  opacity: 0.9;
}

/* ---------- CHAT SECTION ---------- */
.compact-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.compact-bubble {
  padding: 10px 14px;
  border-radius: 16px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  animation: fadeIn 0.3s ease;
}

/* ‚úÖ Final wrapping fix ‚Äî clean, reliable, mobile-safe */
/* ‚úÖ FINAL FIX: multi-line wrapping for user and agent bubbles */
.user-bubble,
.agent-bubble {
  display: block !important;           /* inline-block still gets overridden under flex */
  max-width: 80%;
  white-space: normal !important;      /* force wrapping */
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.5;
  text-align: left;
}

/* ‚úÖ fix the flex parent container */
.compact-messages > .flex {
  align-items: flex-start !important;
  flex-wrap: wrap !important;
  width: 100%;
  gap: 0.25rem;
}

/* optional: ensure internal <br> or markdown formatting render correctly */
.user-bubble br,
.agent-bubble br {
  display: block;
  margin-bottom: 0.25rem;
  content: "";
}




/* AGENT BUBBLE */
.agent-bubble {
  background: #fff;
  align-self: flex-start;
  max-width: 95%;
  border-radius: 14px;
}

/* ---------- FLIGHT HEADER BANNER ---------- */
.header-gradient {
  background: linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%);
  color: #fff;
  font-size: 12.5px;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-bottom: 8px;
}

/* ---------- TABS ---------- */
/* --- Tabs Row --- */
.tab-buttons {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 6px 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #fff;
}

/* --- Individual Tab Buttons --- */
.tab-btn {
  flex: 0 0 auto; /* prevents full stretch */
  padding: 6px 14px;
  font-size: 8px;
  font-weight: 600;
  color: #030f21;
  border-radius: 8px;
  background: #fcfcfc;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.tab-btn:hover {
  background: #f1f5f9;
  color: #0B2C5E;
  border-color: #cbd5e1;
}

/* --- Active Tab --- */
.tab-btn.active {
  background: #ffffff;
  color: ##11546d;
  border: 1px solid #8a8eab;
  font-weight: 900;
  box-shadow: 0 2px 4px rgba(11, 44, 94, 0.25);
}

/* --- Tab Content --- */
.tab-content {
  padding: 10px 12px;
}


/* ---------- FLIGHT CARD ---------- */
.flight-card {
  background: #fff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}
.flight-card:hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  transform: translateY(-1px);
}

/* Flight route section */
.flight-route {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
.flight-route .time {
  font-size: 13px;
  font-weight: 600;
  color: #0B2C5E;
}
.flight-route .duration {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
  color: #555;
}
.flight-route .plane-line {
  position: relative;
  height: 1px;
  width: 60px;
  background: #ccc;
}
.flight-route .plane-line::before {
  content: "‚úàÔ∏è";
  position: absolute;
  top: -9px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
}

/* Flight bottom section */
.flight-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
}
.flight-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11.5px;
  color: #444;
}
.flight-info img {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  object-fit: contain;
}
.flight-price {
  font-weight: 700;
  font-size: 13px;
  color: #1EAD64;
}
/* --- Flight Card Container --- */
.agent-bubble .tab-content {
  padding: 8px 6px; /* reduce side padding so cards can stretch */
}

/* --- Flight Card --- */
.compact-flight-card {
  width: 98%;              /* make it wider */
  margin: 6px auto;        /* center it */
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 10px 14px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.compact-flight-card:hover {
  border-color: #0B2C5E;
  box-shadow: 0 4px 10px rgba(11, 44, 94, 0.1);
  transform: translateY(-1px);
}


/* ---------- INPUT AREA ---------- */
/* === CHAT INPUT BAR CLEAN + ALIGNED === */
.input-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  background: #fff;
  padding: 10px 14px;
  border-top: 1px solid #e5e7eb;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
}

/* Input Field */
.compact-input {
  flex: 1;
  height: 44px;
  padding: 0 16px;
  border: 1px solid #e2e8f0;
  border-radius: 22px;
  font-size: 13px;
  color: #1e293b;
  background: #f8fafc;
  outline: none;
  transition: all 0.2s ease;
}

.compact-input:focus {
  background: #fff;
  box-shadow: 0 0 0 2px rgba(11, 44, 94, 0.15);
}

/* Send Button */
.send-button {
  flex-shrink: 0;
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 50%;
  background: linear-gradient(135deg, #0B2C5E 0%, #B2924C 100%) !important;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(11, 44, 94, 0.25);
  transition: all 0.25s ease;
}

.send-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(11, 44, 94, 0.3);
}

/* Send Button Icon */
.send-button svg {
  stroke: #ffffff !important;
  stroke-width: 2;
  width: 18px;
  height: 18px;
}




/* ---------- ANIMATIONS & SCROLL ---------- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}
.compact-messages::-webkit-scrollbar {
  width: 5px;
}
.compact-messages::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}
.compact-messages::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ‚úÖ Fix: Force proper wrapping for user and agent bubbles */
.user-bubble,
.agent-bubble,
.compact-bubble {
  display: inline-block !important;
  max-width: 75%;
  white-space: normal !important;     /* enable line wrapping */
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.5;
  text-align: left;
}

/* ‚úÖ Fix: Allow flex containers to wrap their children */
.compact-messages > .flex {
  align-items: flex-start !important;
  flex-wrap: wrap !important;
  width: 100%;
}

/* ‚úÖ Optional: Make long links or URLs wrap gracefully */
.compact-bubble a,
.compact-bubble span {
  white-space: normal !important;
  word-break: break-word !important;
}
/* ‚úÖ FINAL FIX ‚Äî multiline user input wrapping (confirmed working) */

/* Allow message containers to wrap properly */
.flex.justify-end, 
.flex.justify-start {
  display: flex !important;
  flex-wrap: wrap !important;
  align-items: flex-start !important;
  max-width: 100%;
}

/* Fix bubble text wrapping */
.user-bubble, 
.agent-bubble {
  display: inline-block !important;
  white-space: normal !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  max-width: 85%;
  line-height: 1.5;
  text-align: left;
}

/* Ensure input bar stays unaffected */
.input-wrapper {
  flex-wrap: nowrap !important;
}

/* ‚úÖ Multi-line Auto-Wrapping Input */
.compact-input {
  flex: 1;
  height: 44px;
  min-height: 44px;
  max-height: 120px;
  padding: 10px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 22px;
  font-size: 13px;
  color: #1e293b;
  background: #f8fafc;
  outline: none;
  resize: none;
  overflow-y: hidden;              /* ‚úÖ no scrollbar flicker */
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.5;
  transition: height 0.15s ease;
}

.input-wrapper {
  align-items: flex-end;
  padding: 10px 14px;
}




</style>

</head>

<body class="bg-gray-50 m-0 p-0 w-full h-screen overflow-hidden">

  <!-- ‚ú® Floating decorative elements -->
  <div class="floating-element floating-1"></div>
  <div class="floating-element floating-2"></div>

  <!-- Error Boundary -->
  <div id="error-boundary" class="hidden"></div>

  <!-- üåç Main Container -->
  <div class="fixed inset-0 flex flex-col bg-white overflow-hidden">

<!-- üîπ Header -->
<header class="bg-gradient-to-r from-[#0B2C5E] to-[#B2924C] text-white flex items-center justify-between px-4 py-3 shadow-md z-10 w-full">

  <!-- Left: Logo + Title -->
  <div class="flex items-center space-x-3">
    <div class="bg-white p-1.5 rounded-xl shadow-md flex items-center justify-center border border-yellow-500/40">
      <img src="static/Logo.jpg" alt="Logo" class="w-6 h-6 sm:w-8 sm:h-8 object-contain">
    </div>
    <div>
      <h1 class="font-semibold text-base sm:text-lg tracking-wide">AI Travel Agent</h1>
      <p class="text-[10px] sm:text-xs opacity-90">Your intelligent travel companion</p>
    </div>
  </div>

  <!-- Right: Floating Header Cart Button -->
  <div id="cart-float-btn"
       class="relative cursor-pointer select-none"
       title="Selected Flights">

      <div class="w-8 h-8 flex items-center justify-center bg-white/90 rounded-full shadow-md border border-yellow-500/40 text-black text-lg">
        ‚úàÔ∏è
      </div>

      <!-- Notification badge -->
      <span id="cart-count"
            class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] px-1.5 py-[1px] rounded-full hidden">
        0
      </span>
  </div>
</header>



<!-- üõí Floating Cart Panel -->
<div id="cart-panel"
     class="fixed top-20 right-3 w-72 bg-white rounded-xl shadow-xl border border-gray-200 p-4 z-50 hidden transition-all duration-300 translate-x-5 opacity-0">

    <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-gray-800">‚úàÔ∏è Selected Flights</h3>
        <button id="cart-close-btn" class="text-red-500 text-sm font-semibold hover:underline">
            Close
        </button>
    </div>

    <!-- Cart items dynamically added here -->
    <div id="cart-items" class="space-y-3 max-h-80 overflow-y-auto">
        <p class="text-gray-500 text-sm">No flights selected yet.</p>
    </div>
</div>




<!-- üìå Cart Toggle Script -->
<script>
  const cartBtn = document.getElementById("cart-float-btn");
  const cartPanel = document.getElementById("cart-panel");
  const cartClose = document.getElementById("cart-close-btn");

  function openCart() {
    cartPanel.classList.remove("hidden");
    setTimeout(() => {
      cartPanel.classList.remove("translate-x-5", "opacity-0");
      cartPanel.classList.add("translate-x-0", "opacity-100");
    }, 10);
  }

  function closeCart() {
    cartPanel.classList.add("translate-x-5", "opacity-0");
    cartPanel.classList.remove("translate-x-0", "opacity-100");
    setTimeout(() => {
      cartPanel.classList.add("hidden");
    }, 250);
  }

  cartBtn.addEventListener("click", openCart);
  cartClose.addEventListener("click", closeCart);
</script>



    <!-- üí¨ Chat Area -->
    <main id="chat-history" class="flex-1 overflow-y-auto bg-gray-50 px-3 py-4">

      <!-- Welcome Message -->
      <div class="flex justify-start">
        <div class="agent-bubble">
          <div class="flex items-center space-x-3 mb-2">
            <div class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-white shadow">
              <img src="./static/person.png" alt="AI Travel Agent" class="object-contain w-7 h-7">
            </div>
            <div>
              <h3 class="font-bold text-gray-900">Welcome to AI Travel Agent!</h3>
              <p class="text-sm text-gray-600">I can help you find flights, hotels, and more.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Flight Tabs -->
      <div id="flight-tabs" class="hidden bg-white rounded-lg shadow-sm mt-4 w-full">
        <div class="flex border-b border-gray-200 text-sm font-medium w-full">
          <button class="tab-btn active flex-1 text-center py-2 border-r border-gray-200" data-tab="tab1">One-way</button>
          <button class="tab-btn flex-1 text-center py-2 border-r border-gray-200" data-tab="tab2">Round-trip</button>
          <button class="tab-btn flex-1 text-center py-2" data-tab="tab3">Multi-city</button>
        </div>
        <div id="tab1" class="tab-content block p-3 w-full"></div>
        <div id="tab2" class="tab-content hidden p-3 w-full"></div>
        <div id="tab3" class="tab-content hidden p-3 w-full"></div>
      </div>
    </main>

    <!-- ‚úçÔ∏è Input Section -->
    <footer class="bg-white border-t border-gray-200 p-3 space-y-3 w-full">
      

      <!-- Input Bar -->
      <div class="flex gap-2 items-end">
        <textarea
          id="user-input"
          class="flex-grow border border-gray-300 rounded-lg p-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-400"
          placeholder="Ask about flights, hotels, weather..."
          rows="1"
        ></textarea>
        <button
          id="send-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 flex items-center justify-center transition"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>

      <!-- Inline Loader -->
      <div id="loading-indicator" class="hidden mt-2">
        <div class="flex items-center justify-center space-x-2 text-gray-600">
          <div class="loading-spinner rounded-full h-4 w-4 border-2 border-blue-200 border-t-blue-600 animate-spin"></div>
          <span class="font-medium text-sm">Processing your request...</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- üíÖ Style Fixes -->
  <style>
    /* spacing between chat bubbles */
    #chat-history > div {
      margin-bottom: 1rem;
    }

    /* user bubble */
    .user-bubble {
      background: #e9f5ff;
      color: #0b2c5e;
      padding: 10px 14px;
      border-radius: 16px 16px 4px 16px;
      max-width: 85%;
      align-self: flex-end;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      word-wrap: break-word;
    }

    /* agent bubble */
    .agent-bubble {
      background: #fff;
      border-radius: 16px 16px 16px 4px;
      max-width: 90%;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    /* breathing room */
    #chat-history {
      padding-bottom: 4.5rem !important;
    }

    /* make flight cards take full width */
    .flight-card,
    .flight-result,
    .flight-offer {
      width: 100% !important;
      max-width: none !important;
      margin: 0 auto;
    }

    /* responsive tweaks */
    @media (max-width: 640px) {
      main#chat-history {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .user-bubble,
      .agent-bubble {
        max-width: 95%;
      }
    }
  </style>
</body>

    <!-- Firebase & Application Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const CONFIG = {
            BACKEND_URL: 'https://ai-travel-agent-backend-0i7n.onrender.com/api/search',
            HISTORY_COLLECTION: 'chat_messages',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000
        };
window.__block_auto_focus = false;


        // Elements
        const elements = {
            chatHistory: document.getElementById('chat-history'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            loadingOverlay: document.getElementById('loading-overlay'),
            multiCopyContainer: document.getElementById('multi-copy-container'),
            multiCopyBtn: document.getElementById('multi-copy-btn'),
            selectedSummary: document.getElementById('selected-flight-summary'),
            selectedText: document.getElementById('selected-flight-text'),
            confirmBtn: document.getElementById('confirm-selection-btn'),
            clearBtn: document.getElementById('clear-selected-flights'),
            errorBoundary: document.getElementById('error-boundary')
        };

        // Global state
        window.appState = {
            selectedFlights: [],
            currentSessionId: 'session_' + Math.random().toString(36).substring(2, 15),
            retryCount: 0
        };

        // Firebase state
        let db = null;
        let auth = null;
        let userId = 'anon_user';

        // Utility functions
function showLoading(show = true) {
  if (show) {
    elements.loadingIndicator.style.display = 'block';
    elements.sendBtn.disabled = true;
  } else {
    elements.loadingIndicator.style.display = 'none';
    elements.sendBtn.disabled = false;
  }
}


function addSelectAllToggle(container) {
  if (!container) return;

  // Avoid duplicate buttons
  if (container.querySelector(".select-all-toggle")) return;

  const selectAllBtn = document.createElement("button");
  selectAllBtn.className =
    "select-all-toggle bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";
  selectAllBtn.textContent = "Select All Flights";

  selectAllBtn.addEventListener("click", () => {
    const cards = container.querySelectorAll(".flight-card");

    if (cards.length === 0) return;

    const allSelected = [...cards].every(card =>
      card.classList.contains("selected")
    );

    if (allSelected) {
      // üëâ DESELECT ALL
      window.appState.selectedFlights = [];

      cards.forEach(card => {
        card.classList.remove("selected", "ring-2", "ring-blue-500", "bg-blue-50");
      });

      selectAllBtn.textContent = "Select All Flights";
      updateSelectionSummary();
      return;
    }

    // üëâ SELECT ALL
    window.appState.selectedFlights = [];

    cards.forEach(card => {
      const flight = JSON.parse(card.dataset.flight);
      window.appState.selectedFlights.push(flight);
      card.classList.add("selected", "ring-2", "ring-blue-500", "bg-blue-50");
    });

    selectAllBtn.textContent = "Deselect All Flights";
    updateSelectionSummary();
  });

  container.appendChild(selectAllBtn);
}










        function showError(message) {
            const errorHtml = `
                <div class="error-banner fade-in">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-red-500">‚ö†Ô∏è</span>
                            <div>
                                <p class="font-semibold">Something went wrong</p>
                                <p class="text-sm">${message}</p>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">
                            ‚úñ
                        </button>
                    </div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = errorHtml;
            elements.chatHistory.appendChild(tempDiv.firstElementChild);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        function showSuccess(message) {
            const successHtml = `
                <div class="success-banner fade-in">
                    <div class="flex items-center space-x-3">
                        <span class="text-green-500">‚úÖ</span>
                        <p class="font-semibold">${message}</p>
                    </div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = successHtml;
            elements.chatHistory.appendChild(tempDiv.firstElementChild);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        // Initialize Firebase
        async function initFirebaseAndAuth() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                
                if (!firebaseConfig) {
                    console.warn("Firebase configuration missing - chat history disabled");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                if (window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`User authenticated: ${userId}`);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                showError("Chat history is temporarily unavailable");
            }
        }

        // Message handling
        async function saveMessage(text, role, type = 'text', data = null) {
            displayMessage(text, role, type, data);

            if (!db || !auth.currentUser) {
                console.warn("Firestore not available - message not saved");
                return;
            }

            try {
                const messageData = {
                    text: text,
                    role: role,
                    type: type,
                    data: data,
                    timestamp: new Date(),
                    userId: userId,
                    appId: window.__app_id || 'travel-agent',
                    sessionId: window.appState.currentSessionId
                };

                const collectionPath = `artifacts/${window.__app_id}/users/${userId}/${CONFIG.HISTORY_COLLECTION}`;
                await addDoc(collection(db, collectionPath), messageData);
                
            } catch (error) {
                console.error("Error saving message:", error);
            }
        }

function displayMessage(text, role, type = "text", data = null) {
            const isUser = role === "user";
            const alignment = isUser ? "justify-end" : "justify-start";
            const bubbleClass = isUser ? "user-bubble compact-bubble" : "agent-bubble compact-bubble";

            // Handle flight recommendations
            if (type === "flight_recommendation" && data) {
                renderFlightRecommendation(data, text);
                return;
            }

            // Regular text message
            const messageDiv = document.createElement("div");
            messageDiv.className = `flex ${alignment}`;

            let contentHTML = text
                .replace(/\n/g, "<br>")
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\*(.*?)\*/g, "<em>$1</em>");

            messageDiv.innerHTML = `
                <div class="${bubbleClass}">
                    ${contentHTML}
                </div>
            `;

            elements.chatHistory.appendChild(messageDiv);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }


        // Flight rendering functions
// Flight rendering functions
function renderFlightRecommendation(flightData, headerText) {
  const chatHistory = document.getElementById("chat-history");

  // Create agent bubble container
  const bubble = document.createElement("div");
  bubble.className = "agent-bubble compact-bubble";

  // Clone the hidden flight tabs template
  const tabsTemplate = document.getElementById("flight-tabs");
  const tabsClone = tabsTemplate.cloneNode(true);

  // ‚úÖ Fix possible reversed tab layout
  const tabButtonsContainer = tabsClone.querySelector(".tab-buttons, .flex");
  if (tabButtonsContainer) {
    tabButtonsContainer.classList.remove("flex-row-reverse", "justify-end", "space-x-reverse");
    tabButtonsContainer.classList.add("flex-row", "justify-start");
  }

  tabsClone.id = ""; // avoid duplicate IDs
  tabsClone.classList.remove("hidden");

  // Add header
  const header = document.createElement("div");
  header.className =
    "flex items-center text-[13px] font-medium text-white mb-2 rounded-md px-3 py-1.5 shadow-sm";
  header.style.background = "linear-gradient(90deg, #0B2C5E 0%, #B2924C 100%)";
  header.innerHTML = `
    <span class="mr-2 text-white text-sm">‚úàÔ∏è</span>
    <span>${headerText}</span>
  `;

  bubble.appendChild(header);
  bubble.appendChild(tabsClone);


  // Wrap in chat message
  const messageWrapper = document.createElement("div");
  messageWrapper.className = "flex justify-start mb-4";
  const avatar = document.createElement("div");
  avatar.className =
    "w-8 h-8 rounded-full overflow-hidden shadow-sm flex items-center justify-center bg-white mr-3";
  avatar.innerHTML = `<img src="/static/person.png" alt="AI Travel Agent" class="object-contain w-7 h-7">`;
  messageWrapper.appendChild(avatar);
  messageWrapper.appendChild(bubble);
  chatHistory.appendChild(messageWrapper);
  chatHistory.scrollTop = chatHistory.scrollHeight;

  // Init tabs
  initLocalTabs(tabsClone);

  // === Determine trip type ===
  const tripType =
    flightData.tripType ||
    (flightData.inbound && flightData.inbound.length
      ? "roundTrip"
      : flightData.flights?.length > 1
      ? "multiCity"
      : "oneWay");

  // === Show/hide relevant tabs ===
  const tabButtons = tabsClone.querySelectorAll(".tab-btn");
  const tabContents = tabsClone.querySelectorAll(".tab-content");
  tabButtons.forEach(btn => (btn.style.display = "block"));
  tabContents.forEach(tab => (tab.style.display = "block"));

  if (tripType === "oneWay") {
    tabsClone.querySelector('[data-tab="tab2"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab3"]').style.display = "none";
    tabsClone.querySelector("#tab2").style.display = "none";
    tabsClone.querySelector("#tab3").style.display = "none";
  } else if (tripType === "roundTrip") {
    tabsClone.querySelector('[data-tab="tab1"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab3"]').style.display = "none";
    tabsClone.querySelector("#tab1").style.display = "none";
    tabsClone.querySelector("#tab3").style.display = "none";
  } else if (tripType === "multiCity") {
    tabsClone.querySelector('[data-tab="tab1"]').style.display = "none";
    tabsClone.querySelector('[data-tab="tab2"]').style.display = "none";
    tabsClone.querySelector("#tab1").style.display = "none";
    tabsClone.querySelector("#tab2").style.display = "none";
  }

  // === Render One-Way Flights ===
  if (tripType === "oneWay") {
    const oneWayTab = tabsClone.querySelector("#tab1");
    const offers = flightData.offers || flightData.flights?.[0]?.offers || [];

    const offersHTML = offers
      .map(
        offer => `
          <div 
            class="flight-card border rounded-lg p-2 mb-2 bg-white shadow-sm hover:shadow transition text-[13px] 
                   w-full sm:w-[98%] mx-auto cursor-pointer"
            data-flight='${JSON.stringify(offer)}'>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <img 
                  src="${offer.logoUrl || `https://content.airhex.com/content/logos/airlines_${offer.carrierCode}_100_100_s.png`}" 
                  alt="${offer.carrierName || 'Airline'} logo"
                  class="w-6 h-6 object-contain rounded bg-gray-50"
                  onerror="this.style.display='none'">
                <div class="text-gray-800">
                  <div class="font-semibold text-[13px] leading-tight">
                    ${offer.carrierName || ''}
                  </div>
                  <div class="text-[11px] text-gray-500 tracking-tight mt-[1px]">
                    ${offer.flightNumber || ''}
                  </div>
                </div>
              </div>
              <div class="text-right text-green-600 font-bold text-[14px]">
                ${offer.price?.total || ''} ${offer.price?.currency || ''}
              </div>
            </div>

            <div class="flex justify-between mt-2 text-gray-700 text-[12px]">
              <div>
                <p><span class="font-medium">${offer.departureTime || ''}</span> Depart</p>
                <p class="text-gray-500 text-[11px]">${offer.departureDate || ''}</p>
                <p class="text-gray-500">${offer.origin || ''}</p>
              </div>
              <div class="text-center">
                <p>‚úàÔ∏è ${offer.flightDuration || ''}</p>
                <p class="${offer.stops > 0 ? 'text-orange-600' : 'text-green-600'}">
                  ${offer.stops > 0 
                      ? `${offer.stops} stop${offer.stops > 1 ? 's' : ''} via ${offer.via || ''}` 
                      : 'Non-stop'}
                </p>
              </div>
              <div class="text-right">
                <p><span class="font-medium">${offer.arrivalTime || ''}</span> Arrive</p>
                <p class="text-gray-500 text-[11px]">${offer.arrivalDate || ''}</p>
                <p class="text-gray-500">${offer.destination || ''}</p>
              </div>
            </div>

            <div class="mt-1 pt-1 text-[11px] text-gray-500 border-t">
              <span>${offer.baggage || '‚Äî'} ‚Ä¢ ${offer.cabin || 'Economy'}</span>
              <div class="fare-breakdown text-[10px] text-gray-600 mt-1 ml-1 leading-tight flex flex-wrap items-center">
                ${
                  [
                    offer.fare_breakdown?.adults?.count > 0
                      ? `üë®‚Äçüíº ${offer.fare_breakdown.adults.count}√óAdult = ${offer.fare_breakdown.adults.total} ${offer.fare_breakdown.currency}`
                      : '',
                    offer.fare_breakdown?.children?.count > 0
                      ? `üßí ${offer.fare_breakdown.children.count}√óChild = ${offer.fare_breakdown.children.total} ${offer.fare_breakdown.currency}`
                      : '',
                    offer.fare_breakdown?.infants?.count > 0
                      ? `üë∂ ${offer.fare_breakdown.infants.count}√óInfant = ${offer.fare_breakdown.infants.total} ${offer.fare_breakdown.currency}`
                      : ''
                  ].filter(Boolean).join(' ‚Ä¢ ')
                }
              </div>
            </div>
          </div>`
      )
      .join('');

oneWayTab.innerHTML =
  offersHTML || "<p class='text-gray-500 text-sm'>No one-way flights found.</p>";

// ‚≠ê Optimized Click Handler (prevents duplicate listeners)
oneWayTab.querySelectorAll(".flight-card").forEach(card => {

  // Remove ALL old listeners by cloning the node
  const newCard = card.cloneNode(true);
  card.replaceWith(newCard);

  // Add a single clean listener
newCard.addEventListener("click", () => {
  const flight = JSON.parse(newCard.dataset.flight);
  toggleSelection(flight, newCard);
});


});

// ‚≠ê ADD SELECT-ALL TOGGLE FOR ONE-WAY
addSelectAllToggle(oneWayTab);

return;



// ‚≠ê ADD SELECT ALL / DESELECT ALL FOR MULTI-CITY ‚≠ê
setTimeout(() => {
  const selectAllBtn = document.createElement("button");
  selectAllBtn.id = "select-all-flights-global";
  selectAllBtn.textContent = "Select All Flights";
  selectAllBtn.className =
    "bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";

  selectAllBtn.addEventListener("click", () => {

    // ‚≠ê This NOW sees flights from ALL segments (because rendering is finished)
    const allCards = tabsClone.querySelectorAll(".flight-card");

    const allSelected = [...allCards].every(card =>
      card.classList.contains("selected")
    );

    if (allSelected) {
      // UNSELECT ALL
      window.appState.selectedFlights = [];
      allCards.forEach(card =>
        card.classList.remove("selected","ring-2","ring-blue-500","bg-blue-50")
      );
      updateSelectionSummary();
      selectAllBtn.textContent = "Select All Flights";
      return;
    }

    // SELECT ALL
    window.appState.selectedFlights = [];

    allCards.forEach(card => {
      const flight = JSON.parse(card.dataset.flight);
      window.appState.selectedFlights.push(flight);
      card.classList.add("selected","ring-2","ring-blue-500","bg-blue-50");
    });

    updateSelectionSummary();
    selectAllBtn.textContent = "Deselect All Flights";
  });

  bubble.appendChild(selectAllBtn);
}, 80); // allow ALL tabs to finish rendering




return;
}


// === Render Round-Trip / Multi-City ===
const tabButtonsContainer2 = tabsClone.querySelector(".flex");
const contentWrapper = tabsClone;

// Remove preset tabs
tabButtonsContainer2.innerHTML = "";
["#tab1", "#tab2", "#tab3"].forEach(sel => {
  const el = tabsClone.querySelector(sel);
  if (el) el.remove();
});

// Normalize segment order
let segments = flightData.flights || [];
if (segments.length === 2) {
  const [seg1, seg2] = segments;
  const isReversed =
    seg1.origin &&
    seg2.destination &&
    seg1.origin === seg2.destination &&
    seg1.destination === seg2.origin;
  if (isReversed) segments = [seg2, seg1];
}

segments = segments.slice().sort(
  (a, b) => new Date(a.departureDate) - new Date(b.departureDate)
);

// === Build tabs & flights ===
segments.forEach((segment, index) => {
  const segNum = index + 1;
  const origin = segment.origin || segment.offers?.[0]?.origin || "N/A";
  const destination =
    segment.destination || segment.offers?.[0]?.destination || "N/A";
  const tabId = `segment-tab-${segNum}`;

  // Tab Button
  const button = document.createElement("button");
  button.className =
    "tab-btn flex-1 py-2 text-center font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent focus:outline-none";
  button.dataset.tab = tabId;
  button.textContent = `${origin} ‚Üí ${destination}`;
  tabButtonsContainer2.appendChild(button);

  // Tab Content
  const tabDiv = document.createElement("div");
  tabDiv.id = tabId;
  tabDiv.className = "tab-content p-4 hidden";

  const offers = segment.offers || [];
const offersHTML = offers
  .map(
    offer => `
      <div class="flight-card border rounded-lg p-2 mb-2 bg-white shadow-sm hover:shadow transition text-[13px]
                  w-full sm:w-[98%] mx-auto cursor-pointer"
           data-flight='${JSON.stringify(offer)}'>

        <!-- Airline + Price -->
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <img
              src="${offer.logoUrl || `https://content.airhex.com/content/logos/airlines_${offer.carrierCode}_100_100_s.png`}"
              alt="${offer.carrierName || "Airline"} logo"
              class="w-6 h-6 object-contain rounded bg-gray-50"
              onerror="this.style.display='none'">
            <div class="text-gray-800">
              <div class="font-semibold text-[13px] leading-tight">
                ${offer.carrierName || ""}
              </div>
              <div class="text-[11px] text-gray-500 tracking-tight mt-[1px]">
                ${offer.flightNumber || ""}
              </div>
            </div>
          </div>

          <div class="text-right text-green-600 font-bold text-[14px]">
            ${offer.price?.total || ""} ${offer.price?.currency || ""}
          </div>
        </div>

        <!-- Timing Row -->
        <div class="flex justify-between mt-2 text-gray-700 text-[12px]">
          <div>
            <p><span class="font-medium">${offer.departureTime || ""}</span> Depart</p>
            <p class="text-gray-500 text-[11px]">${offer.departureDate || ""}</p>
            <p class="text-gray-500">${offer.origin || ""}</p>
          </div>

          <div class="text-center">
            <p>‚úàÔ∏è ${offer.flightDuration || ""}</p>
            <p class="${offer.stops > 0 ? "text-orange-600" : "text-green-600"}">
              ${
                offer.stops > 0
                  ? `${offer.stops} stop${offer.stops > 1 ? "s" : ""} via ${offer.via || ""}`
                  : "Non-stop"
              }
            </p>
          </div>

          <div class="text-right">
            <p><span class="font-medium">${offer.arrivalTime || ""}</span> Arrive</p>
            <p class="text-gray-500 text-[11px]">${offer.arrivalDate || ""}</p>
            <p class="text-gray-500">${offer.destination || ""}</p>
          </div>
        </div>

        <!-- Fare Breakdown + Baggage -->
        <div class="mt-1 pt-1 text-[11px] text-gray-500 border-t">
          <span>${offer.baggage || "‚Äî"} ‚Ä¢ ${offer.cabin || "Economy"}</span>

          <div class="fare-breakdown text-[10px] text-gray-600 mt-1 ml-1 leading-tight flex flex-wrap items-center">
            ${
              [
                offer.fare_breakdown?.adults?.count > 0
                  ? `üë®‚Äçüíº ${offer.fare_breakdown.adults.count}√óAdult = ${offer.fare_breakdown.adults.total} ${offer.fare_breakdown.currency}`
                  : "",
                offer.fare_breakdown?.children?.count > 0
                  ? `üßí ${offer.fare_breakdown.children.count}√óChild = ${offer.fare_breakdown.children.total} ${offer.fare_breakdown.currency}`
                  : "",
                offer.fare_breakdown?.infants?.count > 0
                  ? `üë∂ ${offer.fare_breakdown.infants.count}√óInfant = ${offer.fare_breakdown.infants.total} ${offer.fare_breakdown.currency}`
                  : ""
              ]
                .filter(Boolean)
                .join(" ‚Ä¢ ")
            }
          </div>
        </div>

      </div>`
  )
  .join("");


  tabDiv.innerHTML =
    offersHTML ||
    `<p class="text-gray-500 text-sm">No flights found for ${origin} ‚Üí ${destination}</p>`;

  contentWrapper.appendChild(tabDiv);

  // Enable click selection
  tabDiv.querySelectorAll(".flight-card").forEach(card => {
card.addEventListener("click", () => {
  const flight = JSON.parse(card.dataset.flight);
  toggleSelection(flight, card);
});

  });
});

// ‚≠ê GLOBAL SELECT ALL BUTTON (CORRECT, SAFE)
const globalSelectAllBtn = document.createElement("button");
globalSelectAllBtn.textContent = "Select All Flights";
globalSelectAllBtn.className =
  "bg-blue-600 text-white px-3 py-1 rounded text-xs mt-3";

globalSelectAllBtn.addEventListener("click", () => {
  const allCards = tabsClone.querySelectorAll(".flight-card");

  const allSelected = [...allCards].every(card =>
    card.classList.contains("ring-2")
  );

  if (allSelected) {
    // DESELECT ALL
    window.appState.selectedFlights = [];
    allCards.forEach(card =>
      card.classList.remove("ring-2", "ring-blue-500", "bg-blue-50")
    );
    globalSelectAllBtn.textContent = "Select All Flights";
    updateSelectionSummary();
    return;
  }

  // SELECT ALL
  window.appState.selectedFlights = [];
  allCards.forEach(card => {
    const flight = JSON.parse(card.dataset.flight);
    window.appState.selectedFlights.push(flight);
    card.classList.add("ring-2", "ring-blue-500", "bg-blue-50");
  });

  globalSelectAllBtn.textContent = "Deselect All Flights";
  updateSelectionSummary();
});

// Add global select-all below whole bubble
bubble.appendChild(globalSelectAllBtn);

// Initialize tabs
if (typeof initLocalTabs === "function") initLocalTabs(tabsClone);
const firstTab = tabsClone.querySelector(".tab-btn");
if (firstTab) firstTab.click();
}


function toggleSelection(flight, card) {
  const selected = window.appState.selectedFlights;

  const index = selected.findIndex(f => f.flightNumber === flight.flightNumber);

  if (index === -1) {
    // Select
    selected.push(flight);
    card.classList.add("ring-2", "ring-[#B2924C]", "bg-[#fffbea]", "selected");
  } else {
    // Unselect
    selected.splice(index, 1);
    card.classList.remove("ring-2", "ring-[#B2924C]", "bg-[#fffbea]", "selected");
  }

  updateSelectionSummary();
}



function updateSelectionSummary() {
    const count = window.appState.selectedFlights.length;
    const badge = document.getElementById("cart-count");
    const list = document.getElementById("cart-items");

    // Update badge
    badge.textContent = count > 0 ? count : "";
    badge.style.display = count > 0 ? "flex" : "none";

    list.innerHTML = "";

    if (count === 0) {
        list.innerHTML = `<p class="text-gray-500 text-sm">No flights selected.</p>`;
        return;
    }

    window.appState.selectedFlights.forEach((f, idx) => {
        const card = document.createElement("div");
        card.className =
            "p-3 mb-3 border rounded-lg bg-white shadow-sm text-[12px] leading-tight";

        // Fare breakdown
        const fb = f.fare_breakdown || {};
        const fbLines = [];

        if (fb.adults?.count) {
            fbLines.push(`üßë‚Äçüíº ${fb.adults.count}√óAdult = ${fb.adults.total} AED`);
        }
        if (fb.children?.count) {
            fbLines.push(`üßí ${fb.children.count}√óChild = ${fb.children.total} AED`);
        }
        if (fb.infants?.count) {
            fbLines.push(`üë∂ ${fb.infants.count}√óInfant = ${fb.infants.total} AED`);
        }

        const fareHTML = fbLines
            .map(line => `<div class="ml-1">${line}</div>`)
            .join("");

        // Final HTML
card.innerHTML = `
    <!-- Airline Row -->
    <div class="flex items-center gap-2 mb-2">
        <img 
            src="${f.logoUrl || `https://content.airhex.com/content/logos/airlines_${f.carrierCode}_100_100_s.png`}"
            class="w-6 h-6 object-contain bg-gray-50 rounded"
            onerror="this.style.display='none'"
        >
        <div class="text-[12px]">
            <div class="font-semibold">${f.carrierName || "Airline"}</div>
            <div class="text-[11px] text-gray-500">${f.flightNumber || ""}</div>
        </div>
    </div>

    <!-- Times + Dates -->
    <div class="flex justify-between items-start text-[12px] mt-1">
        
        <!-- Depart -->
        <div class="text-left">
            <div class="font-semibold">${f.departureTime}</div>
            <div class="text-gray-600 text-[11px] mt-[1px]">
                ${f.departureDate}
            </div>
            <div class="text-[11px] text-gray-500">${f.origin}</div>
        </div>

        <!-- Arrow -->
        <div class="text-gray-400 mt-1">‚Üí</div>

        <!-- Arrive -->
        <div class="text-right">
            <div class="font-semibold">${f.arrivalTime}</div>
            <div class="text-gray-600 text-[11px] mt-[1px]">
                ${f.arrivalDate}
            </div>
            <div class="text-[11px] text-gray-500">${f.destination}</div>
        </div>
    </div>

    <!-- Baggage + Cabin -->
    <div class="flex justify-between text-[11px] mt-2">
        <div>üõÑ ${f.baggage || "25 KG"}</div>
        <div class="flex items-center">
            <span class="text-[10px] mr-1">‚óé</span>
            ${f.cabin || "ECONOMY"}
        </div>
    </div>

    <!-- Fare Breakdown -->
    <div class="mt-2 text-[11px] leading-tight">
        ${fbLines
          .map(line => `<div class="flex items-center gap-1 ml-1">${line}</div>`)
          .join("")}
    </div>

    <!-- Price -->
    <div class="text-green-700 font-bold text-right text-[15px] mt-2">
        ${f.price?.total} ${f.price?.currency}
    </div>
`;


        list.appendChild(card);
    });
}





function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr; // fallback if invalid
    const day = String(d.getDate()).padStart(2, "0");
    const month = d.toLocaleString("en", { month: "short" });
    const year = d.getFullYear();
    return `${day} ${month} ${year}`;
  } catch {
    return dateStr;
  }
}


document.addEventListener("DOMContentLoaded", () => {
  const copyBtn = document.getElementById("multi-copy-btn");
  const userInput = document.getElementById("user-input");

  if (!copyBtn) return;

  copyBtn.addEventListener("click", (event) => {
    event.preventDefault();
    event.stopPropagation();

    // ‚ùó Tell system NOT to auto-focus after this
    window.__block_auto_focus = true;

    // ‚ùó Blur input so text does NOT auto-insert
    if (userInput) userInput.blur();

    const selected = window.appState.selectedFlights || [];
    if (selected.length === 0) {
      alert("No flights selected yet!");
      return;
    }

    const sorted = selected.slice().sort(
      (a, b) => new Date(a.departureDate) - new Date(b.departureDate)
    );

    let message = "=== SELECTED FLIGHTS ===\n\n";

    sorted.forEach((f, i) => {
      const firstOrigin = sorted[0].origin;
const label = f.origin === firstOrigin ? "Outbound" : "Inbound";


      const stopInfo =
        f.stops > 0
          ? `${f.stops} stop${f.stops > 1 ? "s" : ""} via ${f.via}`
          : "Non-stop";

      message += `FLIGHT ${i + 1}: ${label}\n`;
      message += `‚Ä¢ ${f.carrierName || "Airline"} ${f.flightNumber || ""}\n`;
      message += `‚Ä¢ Route: ${f.origin} ‚Üí ${f.destination}\n`;
      message += `‚Ä¢ Departure: ${f.departureTime} (${formatDate(f.departureDate)})\n`;
      message += `‚Ä¢ Arrival: ${f.arrivalTime} (${formatDate(f.arrivalDate)})\n`;
      message += `‚Ä¢ ${stopInfo}\n`;
      message += `‚Ä¢ Price (for all pax): ${f.price.total} ${f.price.currency}\n\n`;
    });

   navigator.clipboard.writeText(message).catch(err => {
  console.error("Clipboard copy failed", err);
});
  });
});


document.addEventListener("DOMContentLoaded", () => {
  const selectAllBtn = document.getElementById("select-all-flights");
  if (!selectAllBtn) return;

  selectAllBtn.addEventListener("click", () => {
    const allFlightCards = document.querySelectorAll("[data-flight]");
    if (!allFlightCards.length) {
      alert("No flights available to select.");
      return;
    }

    window.appState.selectedFlights = [];

    allFlightCards.forEach(card => {
      try {
        const flight = JSON.parse(card.dataset.flight);
        window.appState.selectedFlights.push(flight);

        // highlight card visually if you want
        card.classList.add("ring-2", "ring-blue-500");
      } catch (e) {
        console.warn("Invalid flight object", e);
      }
    });

    updateSelectionSummary();
  });
});



// Extract dates that the backend actually used
function getBackendDates(flightData) {

            const backendDates = {
                segment1: null,
                segment2: null
            };

            if (flightData.flights && Array.isArray(flightData.flights)) {
                flightData.flights.forEach((segment, index) => {
                    const flight = segment.offers?.[0];
                    if (flight && flight.departureDate) {
                        backendDates[`segment${index + 1}`] = formatDateForDisplay(flight.departureDate);
                    }
                });
            }

            return backendDates;
        }

        // Check if backend used different dates than requested
        function checkBackendDateMismatch(requestedDates, backendDates) {
            if (!requestedDates.segment1 || !backendDates.segment1) return false;
            
            const requestedOutbound = requestedDates.segment1.toUpperCase();
            const requestedReturn = requestedDates.segment2?.toUpperCase();
            const backendOutbound = backendDates.segment1?.toUpperCase();
            const backendReturn = backendDates.segment2?.toUpperCase();
            
            return (requestedOutbound !== backendOutbound) || (requestedReturn !== backendReturn);
        }

        // Enhanced flight section with better date comparison
        function renderFlightSection(flights, title, color, requestedDate, segmentNumber) {
            if (!flights || flights.length === 0) {
                return `
                    <div class="flight-section">
                        <div class="flight-header" style="color: ${color};">${title}</div>
                        <div class="compact-flight-card">
                            <div class="text-center text-gray-500 py-6">
                                <i class="fas fa-plane-slash text-2xl mb-2 opacity-50"></i>
                                <div>No flights available for this segment</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let html = `
                <div class="flight-section">
                    <div class="flight-header" style="color: ${color};">
                        ${title}
                        ${requestedDate ? `
                            <span class="text-xs font-normal text-gray-500 ml-2">
                                (Requested: ${requestedDate})
                            </span>
                        ` : ''}
                    </div>
            `;

            flights.forEach((flight, index) => {
                html += renderFlightCard(flight, requestedDate, index, segmentNumber);
            });

            html += `</div>`;
            return html;
        }



        // Enhanced flight card with detailed date information
        function renderFlightCard(flight, requestedDate, index, segmentNumber) {
            const departureDate = formatDateForDisplay(flight.departureDate);
            const arrivalDate = formatDateForDisplay(flight.arrivalDate);
            const formattedRequestedDate = formatDateForDisplay(requestedDate);
            
            const hasDateMismatch = formattedRequestedDate && departureDate !== formattedRequestedDate;
            const isReturnFlight = segmentNumber === 2;
            
            // Calculate duration if not provided
            let duration = flight.duration;
            if (!duration && flight.departureTime && flight.arrivalTime) {
                duration = calculateDuration(flight.departureTime, flight.arrivalTime);
            }

            return `
                <div class="compact-flight-card ${hasDateMismatch ? 'date-mismatch' : ''} ${isReturnFlight ? 'return-flight' : ''}">
                    ${hasDateMismatch ? `
                        <div class="date-mismatch-banner">
                            <i class="fas fa-calendar-exclamation mr-1"></i>
                            Showing: ${departureDate} (Requested: ${formattedRequestedDate})
                        </div>
                    ` : ''}
                    
                    <div class="flight-airline">
                        <div class="airline-logo ${isReturnFlight ? 'return-logo' : ''}">
                            ${(flight.carrierCode || 'FL').substring(0, 2)}
                        </div>
                        <div>
                            <div class="airline-name">${flight.carrierName || 'Airline'}</div>
                            <div class="flight-number">
                                <i class="fas fa-plane mr-1"></i>
                                ${flight.flightNumber || 'N/A'}
                            </div>
                        </div>
                    </div>

                    <div class="flight-route">
                        <div class="route-segment">
                            <div class="route-time">${flight.departureTime || '--:--'}</div>
                            <div class="route-date ${hasDateMismatch ? 'text-red-600 font-bold' : ''}">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                ${departureDate}
                            </div>
                            <div class="route-airport">
                                <i class="fas fa-plane-departure mr-1 text-blue-500"></i>
                                ${flight.origin || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="route-connector">
                            <div class="flight-duration">
                                <i class="fas fa-clock mr-1"></i>
                                ${duration || 'N/A'}
                            </div>
                            <div class="connector-line"></div>
                            <div class="flight-stops">
                                ${flight.stops === 0 ? 
                                    '<i class="fas fa-arrow-right mr-1"></i> Non-stop' : 
                                    `<i class="fas fa-map-marker-alt mr-1"></i> ${flight.stops} stop${flight.stops > 1 ? 's' : ''}`
                                }
                            </div>
                        </div>
                        
                        <div class="route-segment">
                            <div class="route-time">${flight.arrivalTime || '--:--'}</div>
                            <div class="route-date">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                ${arrivalDate}
                            </div>
                            <div class="route-airport">
                                <i class="fas fa-plane-arrival mr-1 text-green-500"></i>
                                ${flight.destination || 'N/A'}
                            </div>
                        </div>
                    </div>

                    <div class="flight-price">
                        <div class="price-amount">
                            <i class="fas fa-tag mr-1"></i>
                            ${flight.price?.total || 'N/A'} ${flight.price?.currency || 'AED'}
                        </div>
                        <div class="price-label">Total per passenger ‚Ä¢ Includes taxes</div>
                    </div>

                    <div class="flight-meta">
                        <div class="flight-class">
                            <i class="fas fa-chair mr-1"></i>
                            ${flight.cabin || 'Economy'}
                        </div>
                        <button class="select-flight">
                            <i class="fas fa-check mr-1"></i>
                            Select Flight
                        </button>
                    </div>
                </div>
            `;
        }

        // Helper function to calculate duration
        function calculateDuration(departureTime, arrivalTime) {
            if (!departureTime || !arrivalTime) return 'N/A';
            
            try {
                const [depHours, depMinutes] = departureTime.split(':').map(Number);
                const [arrHours, arrMinutes] = arrivalTime.split(':').map(Number);
                
                let totalMinutes = (arrHours * 60 + arrMinutes) - (depHours * 60 + depMinutes);
                
                // Handle next day arrival
                if (totalMinutes < 0) {
                    totalMinutes += 24 * 60;
                }
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                return `${hours}h ${minutes}m`;
            } catch (error) {
                return 'N/A';
            }
        }

        // Enhanced date extraction for round trip queries
        function extractRequestedDates(query) {
            const dates = {};
            
            // Match round trip patterns like "AUH-BOM-AUH 12 NOV,19 NOV"
            const roundTripPattern = /(\w{3})-(\w{3})-(\w{3})\s+([^,]+),\s*([^,]+)/i;
            const roundTripMatch = query.match(roundTripPattern);
            
            if (roundTripMatch) {
                dates.segment1 = roundTripMatch[4].trim().toUpperCase();
                dates.segment2 = roundTripMatch[5].trim().toUpperCase();
                return dates;
            }
            
            // Match multi-city patterns
            const multiCityPattern = /(\d{1,2}\s+(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*\d{0,4})/gi;
            const dateMatches = query.match(multiCityPattern);
            
            if (dateMatches) {
                dateMatches.forEach((date, index) => {
                    dates[`segment${index + 1}`] = date.toUpperCase().replace(/\s+/g, ' ');
                });
            }
            
            return dates;
        }

        // Helper function to format dates consistently
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return 'N/A';
            
            // Handle different date formats
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }
            
            // Already formatted date
            return dateStr.toUpperCase();
        }

        function attachFlightCardListeners() {
            document.querySelectorAll('.select-flight').forEach(button => {
                button.addEventListener('click', function() {
                    const flightCard = this.closest('.compact-flight-card');
                    const airline = flightCard.querySelector('.airline-name').textContent;
                    const flightNumber = flightCard.querySelector('.flight-number').textContent;
                    const price = flightCard.querySelector('.price-amount').textContent;
                    
                    // Visual feedback
                    this.textContent = '‚úì Selected';
                    this.classList.add('selected');
                    flightCard.classList.add('selected');
                    
                    // Add to selection
                    const selectedFlight = {
                        airline,
                        flightNumber,
                        price,
                        id: Date.now()
                    };
                    window.appState.selectedFlights.push(selectedFlight);
                    updateSelectionUI();
                    
                    showSuccess(`Selected ${airline} ${flightNumber}`);
                });
            });
        }

        function updateSelectionUI() {
    const count = window.appState.selectedFlights.length;

    // üõë Safely fetch elements ‚Äî may return null
    const summary = elements.selectedSummary;
    const text = elements.selectedText;
    const confirmBtn = elements.confirmBtn;
    const copyContainer = elements.multiCopyContainer;
    const copyBtn = elements.multiCopyBtn;

    // üß® If UI elements do NOT exist anymore ‚Äî only update cart and EXIT
    if (!summary || !text || !confirmBtn || !copyContainer || !copyBtn) {
        updateCartCount(count);
        return;
    }

    // üü¢ Older UI still present ‚Üí update normally
    if (count > 0) {
        summary.classList.remove('hidden');
        text.textContent = `‚úàÔ∏è ${count} Flight${count > 1 ? 's' : ''} Selected`;
        confirmBtn.classList.remove('hidden');
        copyContainer.classList.remove('hidden');
        copyBtn.textContent = `Copy ${count} Selected Flight${count > 1 ? 's' : ''}`;
    } else {
        summary.classList.add('hidden');
        confirmBtn.classList.add('hidden');
        copyContainer.classList.add('hidden');
    }

    updateCartCount(count);
}
// üîµ Updates the cart badge count safely
function updateCartCount(count) {
    const cartCountEl = document.getElementById("cart-count");
    if (!cartCountEl) return;    // Prevent crash if icon not loaded

    if (count > 0) {
        cartCountEl.textContent = count;
        cartCountEl.classList.remove("hidden");
    } else {
        cartCountEl.classList.add("hidden");
    }
}


        // API Communication
        async function callGenerativeAgent(query) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(CONFIG.BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-Id': window.appState.currentSessionId
                        },
                        body: JSON.stringify({ query: query })
                    });

                    if (response.ok) {
                        window.appState.retryCount = 0;
                        return await response.json();
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt < CONFIG.MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                    }
                }
            }
            
            throw lastError;
        }

        // Event Handlers
async function handleUserInput() {
  const query = elements.userInput.value.trim();
  if (!query) return;

  // Reset input + disable send
  elements.userInput.value = '';
  elements.sendBtn.disabled = true;
  showLoading(true);

  try {
    // Clear previous selections
    window.appState.selectedFlights = [];
    updateSelectionUI();

    // 1Ô∏è‚É£ Display user's message in chat
    await saveMessage(query, 'user');

    // 2Ô∏è‚É£ Show temporary ‚Äúthinking‚Ä¶‚Äù message depending on query type
    let tempText = "Processing your request...";
    if (/\b(flight|fly|air|return|trip|ticket|airport|departure|arrival)\b/i.test(query)) {
      tempText = "Searching for the best flights...";
    } else if (/\b(weather|temperature|forecast|climate)\b/i.test(query)) {
      tempText = "Checking the latest weather information...";
    } else if (/\b(hotel|resort|stay|accommodation|room)\b/i.test(query)) {
      tempText = "Finding the best hotel options...";
    } else if (/\b(activity|tour|things? to do|sightseeing|attraction)\b/i.test(query)) {
      tempText = "Looking for fun activities...";
    } else if (/\b(time|timezone|local time|clock)\b/i.test(query)) {
      tempText = "Checking the current time...";
    } else if (/\b(agency|company|movie|actor|person|brand|event)\b/i.test(query)) {
      tempText = "Searching for details...";
    } else if (/\b(hi|hello|hey|thanks|thank you)\b/i.test(query)) {
      tempText = "Hi there!";
    }

    await saveMessage(tempText, 'agent', 'text', null);

    // 3Ô∏è‚É£ Send query to backend (Flask API)
    const agentResponse = await callGenerativeAgent(query);

    // 4Ô∏è‚É£ Remove temporary bubble once we have a real response
    const tempMsg = [...elements.chatHistory.querySelectorAll('.agent-bubble')]
      .find(el => el.textContent.trim() === tempText);
    if (tempMsg) tempMsg.remove();

    // 5Ô∏è‚É£ Display backend response appropriately
    if (agentResponse.type === 'flight_recommendation') {
      renderFlightRecommendation(
        agentResponse.data,
        agentResponse.text || "Here are your flight options:"
      );
    } else if (agentResponse.text) {
      await saveMessage(agentResponse.text, 'agent', agentResponse.type, agentResponse.data);
    } else {
      console.warn("‚ö†Ô∏è Backend response missing text:", agentResponse);
      await saveMessage("I couldn‚Äôt find relevant information for that.", 'agent', 'text', null);
    }

  } catch (error) {
    console.error('Agent communication failed:', error);
    const errorMessage = `I encountered an issue while processing your request. Please try again. (Error: ${error.message})`;
    await saveMessage(errorMessage, 'agent', 'text', null);
} finally {
    showLoading(false);
    elements.sendBtn.disabled = false;

    // ‚úÖ Prevent autofocus if clipboard copy triggered
    if (!window.__block_auto_focus) {
      elements.userInput.focus();
    }

    // Reset flag after send cycle
    window.__block_auto_focus = false;
}

}





        // Event Listeners
document.querySelectorAll('.quick-action').forEach(btn => {
    btn.addEventListener('click', function() {

        // ‚ùó Skip for Copy Selected Flights button
        if (this.id === "multi-copy-btn") return;

        const query = this.getAttribute('data-query') || this.textContent;
        elements.userInput.value = query;
        elements.userInput.focus();
    });
});


        elements.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !elements.sendBtn.disabled) {
                handleUserInput();
            }
        });

        elements.sendBtn.addEventListener('click', handleUserInput);


// üî• FIX: Prevent auto-writing into the input when clicking copy buttons
document.addEventListener("click", (e) => {
    const copyBtn = e.target.closest("#multi-copy-btn");

    if (copyBtn) {
        const input = document.getElementById("user-input");
        if (input) {
            input.blur();
            input.setSelectionRange(0, 0);
        }
    }
});

// FIX: Remove paste restrictions because multi-copy-btn no longer exists
document.getElementById("user-input")?.addEventListener("paste", () => {});


// ‚ùå OLD BUTTON REMOVED ‚Äî DO NOT ATTACH LISTENERS
// elements.confirmBtn DOES NOT EXIST ANYMORE
// So we delete this whole block
// ----------------------------------------------------
// (REMOVED)


// ‚úÖ INITIALIZE SYSTEM SAFELY
document.addEventListener('DOMContentLoaded', function () {
    try {
        initFirebaseAndAuth().catch(console.error);
    } catch (e) {
        console.warn("Firebase init skipped:", e);
    }

    const input = document.getElementById("user-input");
    if (input) input.focus();

    console.log("AI Travel Agent initialized successfully");
});


// ----------------------------------------------------
// ‚≠ê GLOBAL MENU HANDLER (SAFE)
// ----------------------------------------------------
window.handleMenuSelection = async function (optionId) {
    try {
        const response = await fetch("http://localhost:5000/api/flow", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-Id": window.appState.currentSessionId
            },
            body: JSON.stringify({ selected: optionId })
        });

        const result = await response.json();
        await saveMessage(result.text, "agent", result.type, result.data);
    } catch (error) {
        console.error("Menu selection failed:", error);
        showError("Sorry, something went wrong. Please try again.");
    }
};

function initLocalTabs(tabContainer) {
  const buttons = tabContainer.querySelectorAll('.tab-btn');
  const contents = tabContainer.querySelectorAll('.tab-content');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Remove active from all in this container
      buttons.forEach(b => b.classList.remove('active'));
      contents.forEach(c => c.classList.add('hidden'));

      // Activate only selected
      btn.classList.add('active');
      const targetId = btn.dataset.tab;
      const target = tabContainer.querySelector(`#${targetId}`);
      if (target) target.classList.remove('hidden');
    });
  });
}

const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

// ‚úÖ Auto-expand while typing
userInput.addEventListener("input", () => {
  userInput.style.height = "auto";
  userInput.style.height = Math.min(userInput.scrollHeight, 120) + "px";
});

// ‚úÖ Clean reset after sending
function resetInput() {
  userInput.value = "";
  userInput.style.height = "44px";      // restore exact base height
  userInput.blur();                     // prevent cursor artifacts
}

// ‚úÖ Click send
sendBtn.addEventListener("click", () => {
  // ... your existing sendMessage() logic ...
  setTimeout(resetInput, 50);           // small delay ensures layout flush
});

// ‚úÖ Enter = send, Shift+Enter = newline
userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});



// Toggle Cart Panel
document.getElementById("cart-float-btn").addEventListener("click", () => {
  const panel = document.getElementById("cart-panel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
});

// Update airplane badge count
function updateCartBadge() {
  const badge = document.getElementById("cart-count");
  const count = window.appState.selectedFlights.length;

  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

// Hook into selection summary
const oldUpdate = updateSelectionSummary;
updateSelectionSummary = function() {
  oldUpdate();
  updateCartBadge();
};




    </script>
</body>
</html>
